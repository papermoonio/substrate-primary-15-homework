# åŒºå—é“¾æŠ€æœ¯ä¸åº”ç”¨

[TOC]

---

## BTC-å¯†ç å­¦åŸç†

### (1)cryptographic hash function

- collision resistance
- hiding å•å‘ä¸å¯é€†

ä¸Šè¿°ä¸¤ç§æ€§è´¨å¯ä»¥å®ç°digital commitmentæˆ–è€…digital equivalent of a sealed envelope (sealed envelopï¼šé¢„æµ‹å¯èƒ½ä¼šå¯¹ç»“æœäº§ç”Ÿå½±å“ï¼Œå› æ­¤å¯ä»¥å°†$H(x)$ä½œä¸ºé¢„æµ‹å€¼å…¬å¸ƒï¼Œä¹‹åéªŒè¯$x$ï¼Œå®é™…æ“ä½œçš„æ—¶å€™ç”¨çš„æ˜¯$H(x||nonce)$æ¥ä¿è¯å‡åŒ€åˆ†å¸ƒ)

BTCä½¿ç”¨çš„hash (SHA-256, Secure Hash Algorithm) è¿˜æœ‰ä¸€ä¸ªæ€§è´¨ï¼š

- puzzle friendly (difficult to solve, but easy to verify)

    æŒ–çŸ¿å°±æ˜¯ä¸€ç›´è¯•ä¸åŒçš„$nonce$ä½¿å¾—$H(block~header)\le target$å³ä¸ºåˆæ³•å€¼ï¼Œè¿™ä¸ªè¯è¡¨ç¤ºå¿…é¡»é€šè¿‡éå†æ¥è¯•â€”â€”å·¥ä½œé‡è¯æ˜proof of work

### (2)éå¯¹ç§°åŠ å¯†

**è´¦æˆ·ç®¡ç†**

å¼€æˆ·çš„è¿‡ç¨‹ï¼šåˆ›å»ºä¸€ä¸ªå…¬é’¥å’Œç§é’¥ `(public key, private key)`

åŠ å¯†å’Œè§£å¯†ç”¨çš„éƒ½æ˜¯æ¥æ”¶æ–¹çš„ï¼Œå…¬é’¥åŠ å¯†ç§é’¥è§£å¯†

å…¬é’¥ï¼šè´¦å·ï¼›ç§é’¥ï¼šå¯†ç 

BTCäº¤æ˜“æ—¶ç”¨ç§é’¥æ¥åšç­¾åï¼Œå…¶ä»–äººç”¨å…¬é’¥è§£å¯†éªŒè¯

å‡è®¾äº§ç”Ÿå…¬ç§é’¥çš„è¿‡ç¨‹ä½¿ç”¨çš„æ˜¯å¥½çš„éšæœºå…ƒ a good source of randomness



æ¯”ç‰¹å¸ å¯¹ä¸€ä¸ªmessageå–hashï¼Œå†å¯¹hashç­¾å

---

## BTC-æ•°æ®ç»“æ„

### (1)Hash pointers

ä¿å­˜ç»“æ„ä½“é¦–åœ°å€å’Œå…¶hashå€¼

å¦‚æœæœ‰ç¯çš„è¯ï¼Œå°±äº§ç”Ÿé—®é¢˜ï¼Œå¯¼è‡´æ— é™hashè®¡ç®—ä¸‹å»

### (2)Blockchain

Block chain is a linked list using hash pointers.ç›¸å¯¹äºä¼ ç»Ÿé“¾è¡¨ï¼Œä½¿ç”¨hash pointer ä»£æ›¿ä¼ ç»Ÿpointer

![](åŒºå—é“¾æŠ€æœ¯ä¸åº”ç”¨.assets/hash-pointer.png)

ç¬¬ä¸€ä¸ªåŒºå—å«genesis blockï¼Œæœ€åä¸€ä¸ªåŒºå—æ˜¯most recent blockï¼Œç”±hash pointerè¿æ¥èµ·æ¥ï¼Œæ³¨æ„hashå€¼æ˜¯å¯¹å‰ä¸€ä¸ªåŒºå—æ•´ä½“å–hashå¾—åˆ°çš„â€”â€”>tamper-evident log(ç¯¡æ”¹è¯æ˜è®°å½•,åªéœ€æ£€æµ‹æœ€åä¸€ä¸ªhash,å³å¯æ£€æµ‹)

èŠ‚ç‚¹ä¸éœ€è¦ç»´æŠ¤æ‰€æœ‰åŒºå—ï¼Œä»…éœ€ç»´æŠ¤æœ€è¿‘åŒºå—

### (3)Merkle Tree

å’ŒBinary Treeçš„åŒºåˆ«æ˜¯ç”¨hash pointerä»£æ›¿binary treeçš„æŒ‡é’ˆ

![](åŒºå—é“¾æŠ€æœ¯ä¸åº”ç”¨.assets/merkle-tree.png)

å†…éƒ¨èŠ‚ç‚¹éƒ½æ˜¯hash pointerï¼Œleafæ˜¯data blockï¼ˆäº¤æ˜“æ•°æ®transactionï¼‰ï¼Œå¯¹æ ¹èŠ‚ç‚¹å–hashå°±æ˜¯root hash

- block header => äº¤æ˜“çš„æ ¹hash
- block body =>äº¤æ˜“åˆ—è¡¨

BTCæœ‰ä¸¤ç§èŠ‚ç‚¹ï¼šå…¨èŠ‚ç‚¹ï¼ˆä¿å­˜block headerå’Œblock bodyï¼‰å’Œè½»èŠ‚ç‚¹ï¼ˆåªä¿å­˜block headerï¼‰ï¼ŒMerkle Treeæä¾›äº†Merkle proof

![](åŒºå—é“¾æŠ€æœ¯ä¸åº”ç”¨.assets/litenode-verify-tx.png)

proof of membership (inclusion) å¤æ‚åº¦ $\Theta(\log n)$

proof of non-membership (non-membership)ï¼šå°†leafæŒ‰ç…§hashå€¼æ’åºï¼Œç„¶åå¯¹éœ€è¦è¢«éªŒè¯çš„transactionå–hashçœ‹ä½äºå“ªä¸¤ä¸ªleafä¹‹é—´ï¼Œåªè¦èƒ½è¯æ˜è¿™ä¸¤ä¸ªleafèƒ½å¤Ÿæ¨åˆ°rootæ­£ç¡®å³å¯ã€‚éªŒè¯å¤æ‚åº¦ $\Theta(\log n)$ï¼Œéœ€è¦æ’åºçš„ç§°ä¸ºSorted Merkle Treeä½†æ˜¯BTCä¸éœ€è¦éªŒè¯non-membership

---

## BTC-åè®®

---

### (1)éªŒè¯äº¤æ˜“åˆæ³•æ€§

æ•°å­—è´§å¸å­˜åœ¨**double spending attack**(æ•°å­—è´§å¸ç›¸å½“äºä¸€ä¸ªæ–‡ä»¶ï¼Œå¯å¤åˆ¶å•Š)

- ä¸­å¿ƒåŒ–æ–¹æ¡ˆï¼šæ¯ä¸ªæ•°å­—è´§å¸è®¾æœ‰ç¼–å·ï¼Œå¤®è¡Œç»´æŠ¤æ•°æ®åº“ï¼Œè®°å½• ç¼–å·<=>user,ä½¿ç”¨æ—¶ï¼ŒéªŒè¯å¤®è¡Œæ•°å­—ç­¾åï¼Œå¹¶å‘å¤®è¡Œæ ¸å®ã€‚å¤®è¡Œéœ€è¦æŒæ¡æ‰€æœ‰è´§å¸åŠ¨å‘ï¼Œå¤ªéº»çƒ¦ğŸ˜”
- å»ä¸­å¿ƒåŒ–æ–¹æ¡ˆï¼šæ•°å­—è´§å¸å‘è¡Œï¼Ÿ**æŒ–çŸ¿**     éªŒè¯äº¤æ˜“æœ‰æ•ˆæ€§ï¼Ÿ

![](åŒºå—é“¾æŠ€æœ¯ä¸åº”ç”¨.assets/transaction.png)

åŒºå—é“¾ï¼šæ¯ä¸ªäº¤æ˜“è¦åŒ…å«è¾“å…¥å’Œè¾“å‡ºï¼Œè¾“å…¥åŒ…å«å¸çš„æ¥æºâ€”â€”é“¸å¸äº¤æ˜“coinbase transactionï¼ˆä½¿ç”¨hashæŒ‡é’ˆï¼‰ä»¥åŠ**è½¬è´¦äººçš„å…¬é’¥**ï¼Œè¾“å‡ºåŒ…å«æ”¶æ¬¾äººå…¬é’¥çš„hash(åœ°å€)ï¼Œè¿˜éœ€è¦è½¬è´¦äººçš„ç­¾å

- hashæŒ‡é’ˆï¼š è¿æ¥åŒºå— | å¸çš„æ¥æº(è¯æ˜å¸éå‡­ç©ºæé€ ï¼Œé˜²åŒèŠ±)
- æ¯”ç‰¹å¸é’±åŒ…ä¸­å…¬é’¥ä¼ª512ä½ï¼Œé€šè¿‡è®¡ç®—hashè·å–ä¸€ä¸ª160ä½åœ°å€

æ¯ä¸ªèŠ‚ç‚¹éƒ½éœ€è¦çŸ¥é“è½¬è´¦äººçš„å…¬é’¥ï¼Œå› ä¸ºäº¤æ˜“ç­¾åä½¿ç”¨çš„æ˜¯è½¬è´¦äººçš„ç§é’¥ï¼Œå¤§å®¶éªŒè¯éœ€è¦ä½¿ç”¨å…¶å…¬é’¥éªŒè¯åˆæ³•æ€§

**é“¸å¸äº¤æ˜“çš„è¾“å‡ºåŒ…å«è·å¾—äººçš„å…¬é’¥çš„hashï¼Œåç»­äº¤æ˜“çš„è¾“å…¥å…¬é’¥éœ€è¦å’Œæœ€åˆçš„coinbaseäº¤æ˜“çš„å…¬é’¥å¯¹å¾—ä¸Š**

å®é™…ä¸ŠBTCä¸Šæ¯ä¸ªåŒºå—é“¾ä¸Šéƒ½ä¹Ÿå¾ˆå¤šäº¤æ˜“ç»„æˆMerkle Tree

---

### (2)åŒºå—ç»„æˆ

æ¯ä¸ªåŒºå—åˆ†æˆBlock headerå’ŒBlock body

| Block header                                                 | Block body       |
| ------------------------------------------------------------ | ---------------- |
| version                                                      | transaction list |
| hash of previous block header <br/>(only caculate block header) |                  |
| Merkle root hash                                             |                  |
| target (æŒ–çŸ¿éš¾åº¦ç›®æ ‡é¢„å€¼)<br/>nBitsï¼ˆ256ä½targetçš„å‹ç¼©ç¼–ç  4bytesï¼‰ |                  |
| nonce                                                        |                  |

BTCæ¯ä¸ªèŠ‚ç‚¹å¯åˆ†ä¸ºfull node (fully validating node) å’Œ light node (åªä¿å­˜block header)ï¼Œä¸»è¦æ˜¯åè€…

---

### (3)å…±è¯†æœºåˆ¶

è´¦æœ¬å†…å®¹è¦å–å¾—åˆ†å¸ƒå¼çš„å…±è¯†distributed consensusï¼Œå…±åŒç»´æŠ¤distributed hash table

æœ‰äººæå‡ºFLP impossibility resultï¼Œå³åœ¨ä¸€ä¸ªå¼‚æ­¥ä¸”æ—¶å»¶æ²¡æœ‰ä¸Šé™çš„ç½‘ç»œä¸­ï¼Œåªè¦æœ‰ä¸€ä¸ªäººæ˜¯faultyï¼Œæ•´ä¸ªç½‘ç»œå°±æ— æ³•è¾¾æˆå…±è¯†ï¼›å¦å¤–æœ‰äººæå‡ºCAP Theorem (Consistency, Availability, Partition tolerance)ï¼Œå³è¿™ä¸‰ä¸ªæ€§è´¨æœ€å¤šå¾—åˆ°ä¸¤ä¸ª

capç†è®º

BTCçš„å…±è¯†åè®®ï¼š

è‹¥é‡‡ç”¨ç®€å•æŠ•ç¥¨ï¼Œéœ€è¦ç¡®å®šmembershipï¼ˆå¦‚hyperledger fabricè”ç›Ÿé“¾ï¼Œåªæœ‰æŸäº›å¤§å…¬å¸èƒ½å‚ä¸ï¼ŒæŠ•ç¥¨å¯ä»¥ï¼‰ï¼ŒBTCä¸­æ¶æ„è€…ä¸æ–­äº§ç”Ÿå…¬ç§é’¥å°±ä¸€ç›´è·å¾—æŠ•ç¥¨æƒsybil attack(å¥³å·«æ”»å‡»)ã€‚  

æ¯”ç‰¹å¸æŠ•ç¥¨æœºåˆ¶ä¸ºç®—åŠ›  hash rateï¼Œåˆ›å»ºè´¦æˆ·å¹¶ä¸èƒ½æ”¹å˜æŠ•ç¥¨æƒé‡

**åœ¨BTCä¸­ï¼Œ$H(block~header)\le target$ä¸­æœ‰ä¸€ä¸ª4bytesçš„$nonce$ï¼Œæ±‚å‡ºç¬¦åˆè¯¥å¼çš„$nonce$å³å¯è·å¾—è®°è´¦æƒï¼Œå…¶ä»–èŠ‚ç‚¹æ¥æ”¶åˆ°åŒºå—éœ€è¦éªŒè¯åŒºå—åˆæ³•æ€§(blockheader blockbody->tx)**



å½“hash of previous block headerä¸æ˜¯æŒ‡å‘longest valid chainçš„æœ€åçš„æ—¶å€™ï¼Œè¿™ä¸ªåŒºå—å°±æ–°å¼€äº†ä¸€ä¸ªåˆ†æ”¯ï¼ˆåˆ†å‰æ”»å‡»forking attackï¼‰ï¼Œæ­£å¸¸æƒ…å†µåº”è¯¥æ˜¯æ¥åœ¨æœ€é•¿åˆæ³•é“¾çš„åé¢ã€‚

![](åŒºå—é“¾æŠ€æœ¯ä¸åº”ç”¨.assets/fork.png)

ä½†æ˜¯è¿˜æœ‰ä¸€ç§æƒ…å†µï¼Œä¸¤ä¸ªåŒºå—åŒæ—¶è·å¾—è®°è´¦æƒï¼Œéƒ½æ¥åœ¨longest valid chainçš„æœ€åäº§ç”Ÿåˆ†å‰ï¼Œæ­¤æ—¶å„ä¸ªæœ¬åœ°åŒºå—ä¼šæ ¹æ®ç½‘ç»œå»¶è¿Ÿå…ˆæ¥ä¸Šä¸¤è€…ä¹‹ä¸€ã€‚ä¹‹åå¦‚æœåœ¨ä¸¤è€…å…¶ä¸­ä¹‹ä¸€ç»§ç»­å…ˆæ‰©å±•ä¸‹ä¸€ä¸ªåŒºå—ï¼ˆçœ‹ç®—åŠ›å’Œè¿æ°”ï¼‰å°±å˜æˆäº†æœ€é•¿åˆæ³•é“¾ï¼Œå¦å¤–ä¸€ä¸ªå°±å˜æˆäº†orphan blockè¢«ä¸¢å¼ƒæ‰

---

### (4)é“¸å¸æ–¹å¼

BTCè®¾ç½®block rewardæ¥è®©å¤§å®¶äº‰å¤ºè®°è´¦æƒï¼Œå› ä¸ºè¿™æ˜¯é“¸å¸(**coinbase transaction**)çš„å”¯ä¸€æ–¹å¼

50BTC  â€”â€”>  25BTC  â€”â€”> 12.5BTC   (æ¯äº§ç”Ÿ21ä¸‡ä¸ªåŒºå— ï¼Œå‡ºå—å¥–åŠ±å‡åŠ)

---

## BTC-ç³»ç»Ÿå®ç°

BTCï¼štransaction-base ledger (åŸºäºäº¤æ˜“çš„è´¦æœ¬ï¼Œæ¯”ç‰¹å¸ä¸­æ¯ä¸ªè´¦æˆ·ä¸ä¼šæ˜¾å¼æŒ‡å®šä½™é¢ï¼Œé€šè¿‡äº¤æ˜“è¾“å…¥è¾“å‡º)

ETHï¼šaccount-based ledger   ç³»ç»Ÿæ˜¾å¼åœ°è®°å½•æ¯ä¸ªè´¦æˆ·ä¸Šçš„å¸

å…¨èŠ‚ç‚¹åœ¨å†…å­˜ä¸­ç»´æŠ¤UTXO (Unspent Transaction Outputï¼Œæ‰€æœ‰æœªäº¤æ˜“çš„è¾“å‡ºç»„æˆçš„é›†åˆ)ã€‚æ¯ä¸ªUTXOéœ€è¦ç»™å‡ºäº§ç”Ÿè¾“å‡ºäº¤æ˜“çš„hashï¼Œä»¥åŠåœ¨äº¤æ˜“ä¸­æ˜¯ç¬¬å‡ ä¸ªè¾“å‡ºï¼Œè¿›è€Œå®šä½äº¤æ˜“ä¸­UTXOçš„è¾“å‡ºã€‚å¿«é€Ÿæ£€æµ‹double spending

![](åŒºå—é“¾æŠ€æœ¯ä¸åº”ç”¨.assets/utxo.png)

`total inputs == total outputs`

é™¤äº†å‡ºå—å¥–åŠ±ä¹‹å¤–ï¼Œä¸ºäº†é˜²æ­¢æŸäººåœ¨æ‰“åŒ…åŒºå—é“¾çš„æ—¶å€™åªæ‰“åŒ…è‡ªå·±çš„äº¤æ˜“è®°å½•ï¼Œäºæ˜¯æä¾›äº†transaction feeä½œä¸ºå¥–åŠ±

![](åŒºå—é“¾æŠ€æœ¯ä¸åº”ç”¨.assets/blockchain-info.png)



block header data structure

![](åŒºå—é“¾æŠ€æœ¯ä¸åº”ç”¨.assets/header-structure.png)



ä¸ºäº†å¢å¤§nonce(2^32)çš„æœç´¢ç©ºé—´ï¼Œå¯ä»¥ä½¿ç”¨coinbase txnçš„å‰å‡ ä¸ªå­—èŠ‚ä½œä¸ºextra nonceï¼Œå› ä¸ºcoinbase txnçš„å†…å®¹æ˜¯éšæ„çš„ä½†æ˜¯ä¿®æ”¹å®ƒä¼šå¯¼è‡´Merkle Tree Rootçš„hashå€¼å‘ç”Ÿæ”¹å˜,(çœŸæ­£æŒ–çŸ¿æ—¶æœ‰ä¸¤å±‚å¾ªç¯ï¼Œå¤–å±‚å¾ªç¯è°ƒæ•´coninbase çš„extra nonce ,ç®—å‡ºblock header çš„root hash,å†…å±‚å¾ªç¯è°ƒæ•´blockheaderçš„nonce)

æ³¨æ„ä¸‹å›¾æ‹¼æ¥çš„txä¿¡æ¯ä¸º Merkle Tree root hash, å¹¶éå®é™…çš„äº¤æ˜“ä¿¡æ¯

![](åŒºå—é“¾æŠ€æœ¯ä¸åº”ç”¨.assets/hash-puzzles.png)

å°è¯•nonceæˆåŠŸæ˜¯ä¼¯åŠªåˆ©è¿‡ç¨‹(Bernoulli trailï¼š a random experiment with binary outcome,Bernoulli processï¼š asequence of independent Bernoulli trails)ï¼Œæ¥è¿‘äºPossionåˆ†å¸ƒï¼Œæ— è®°å¿†æ€§ï¼ˆmemorylesså°†æ¥æŒ–çš„æ—¶é—´å’Œè¿‡å»æŒ–çš„æ—¶é—´æ²¡æœ‰å…³ç³»ï¼‰ï¼Œç³»ç»Ÿå¹³å‡å‡ºå—æ—¶é—´ä¸º10min

![](åŒºå—é“¾æŠ€æœ¯ä¸åº”ç”¨.assets/process.png)

BTCçš„æ•°é‡(geometric series)ï¼š
$$
210000*50+210000*25+\dots\\=210000*50*(1+\frac12+\frac14+\dots)=21000000
$$
æŒ–çŸ¿æ±‚è§£è¿‡ç¨‹æ²¡æœ‰æ„ä¹‰ï¼Œä½†æ˜¯Bitcoin is secured by miningï¼šå½“å¤§éƒ¨åˆ†ç®—åŠ›æŒæ¡åœ¨è¯šå®èŠ‚ç‚¹ä¸Šçš„æ—¶å€™å°±æ˜¯å®‰å…¨çš„ï¼ˆç”¨ç®—åŠ›æŠ•ç¥¨ï¼‰

è®°è´¦æƒçš„è·å¾—æœ‰æ—¶å€™çœ‹è¿æ°”ï¼Œæ‰€ä»¥å¯èƒ½ä¼šè½å…¥æ¶æ„èŠ‚ç‚¹ï¼Œæ­¤æ—¶

- ä¸èƒ½å·å¸ï¼ˆå› ä¸ºæ²¡æœ‰è½¬è´¦äººçš„ç§é’¥ç­¾åï¼Œå³ä½¿å†™åˆ°é“¾ä¸Šï¼Œè¯šå®èŠ‚ç‚¹ä¸ä¼šæ¥å—åŒºå—(åŒ…å«éæ³•äº¤æ˜“)ï¼Œä¼šç»§ç»­å‘ä¸‹æŒ–ï¼Œå®ƒä¸æ˜¯æœ€é•¿**åˆæ³•**é“¾æ‰€ä»¥è¯šå®èŠ‚ç‚¹ä¸ä¼šæ¥ä¸Šå»ï¼Œæ‰€ä»¥æ­¤æ¶æ„æ”»å‡»è€…ç”šè‡³æ‹¿ä¸åˆ°å‡ºå—å¥–åŠ±

- å¯èƒ½å‡ºç°double spendingâ€”â€”éš¾åº¦è¾ƒå¤§ï¼ˆforking attackï¼ŒåŒæ—¶å†™å…¥è½¬è´¦å’Œå›æ»šäº§ç”Ÿåˆ†æ”¯ï¼Œäº¤æ˜“å¹³å°çœ‹åˆ°å†™å…¥è½¬è´¦çš„åŒºå—å°±è®¤ä¸ºäº¤æ˜“æˆåŠŸï¼Œä½†æ˜¯ä¹‹åå¯èƒ½å›æ»šåˆ†æ”¯æˆä¸ºæœ€é•¿åˆæ³•é“¾ï¼Œå¦‚æœæœ¬æ¥è½¬è´¦åˆ†æ”¯ä¹‹åå°±å·²ç»æ¥ç€å¾ˆå¤šåŒºå—äº†ï¼Œè¿™ç§æ–¹æ³•å°±æ¯”è¾ƒå›°éš¾ï¼Œæ‰€ä»¥BTCçš„é˜²èŒƒæ–¹æ³•æ˜¯six confirmationï¼Œéœ€è¦1å°æ—¶æ—¶é—´ï¼Œæ•…BTCçš„ä¸å¯ç¯¡æ”¹æ€§æ˜¯æ¦‚ç‡ä¸Šçš„ä¿è¯ï¼›å¦ä¸€ç§æ–¹æ³•æ˜¯zero confirmationï¼Œç›´æ¥é€‰æ‹©æœ€å…ˆè¢«æ¥å—çš„èŠ‚ç‚¹ï¼Œæˆ–è€…ç”µå•†å¹³å°æœ¬æ¥äº¤æ˜“å®Œåˆ°å‘è´§å°±æœ‰æ—¶é—´å·®å¯ä»¥ç”¨æ¥æ£€éªŒåˆæ³•æ€§ï¼‰

- æ³¨æ„bitcoin å¯ä»¥è§£å†³ä¹°å®¶æ¬ºéª—å–å®¶ï¼Œæ— æ³•è§£å†³å–å®¶æ¬ºéª—ä¹°å®¶é—®é¢˜

    ![](åŒºå—é“¾æŠ€æœ¯ä¸åº”ç”¨.assets/confirmation.png)

- æ•…æ„ä¸åŒ…å«åˆæ³•äº¤æ˜“ï¼Œä½†æ˜¯æ€»æœ‰åˆæ³•çš„åŒºå—ä¼šå‘å¸ƒè¿™äº›äº¤æ˜“

- selfish miningâ€”â€”æ­£å¸¸æƒ…å†µä¸‹æŒ–åˆ°åŒºå—ç›´æ¥å‘å¸ƒï¼Œä½†æ˜¯ä¹Ÿå¯ä»¥æŒ–åˆ°å¤šå—åŒºå—è¿åœ¨ä¸€èµ·ç„¶åforking attackä¸€æ¬¡æ€§æ¥ä¸Šå»ã€‚ä½†æ˜¯å‰ææ˜¯æ¶æ„ç®—åŠ›æ¯”è¾ƒå¤§çš„æ—¶å€™æ‰æ¯”è¾ƒå®¹æ˜“æˆåŠŸç¯¡æ”¹ã€‚ä½†æ˜¯è¿™ç§æ–¹æ³•ä¹Ÿæœ‰å¥½å¤„(å•çº¯èµšå–å‡ºå—å¥–åŠ±ï¼Œå…ˆæŒ–ä¸€ä¸ªä¸å‘å¸ƒï¼Œå†æŒ–ä¸‹ä¸€ä¸ªï¼Œç„¶åæŠ¢å…ˆå‘å¸ƒ)ï¼Œå‡å°‘ç«äº‰ï¼Œå…³é”®è¿˜æ˜¯éœ€è¦ç®—åŠ›æ¯”è¾ƒå¤§ï¼Œé£é™©åœ¨äºè¿ç»­å…ˆäºå…¶ä»–äººå®ŒæˆæŒ–çŸ¿çš„æ¦‚ç‡å¾ˆä½

---

## BTC-ç½‘ç»œ

BTCå·¥ä½œåœ¨application layerï¼Œåº•å±‚network layeræ˜¯P2P Overlay Networkï¼Œåœ¨è¿™ä¸ªç½‘ç»œé‡Œæ‰€æœ‰èŠ‚ç‚¹éƒ½æ˜¯å¹³ç­‰çš„ï¼Œæ²¡æœ‰super node/master nodeï¼ŒåŠ å…¥ç½‘ç»œéœ€è¦çŸ¥é“seed node(ç§å­èŠ‚ç‚¹),ç„¶åä¸ä¹‹è¿çº¿ï¼ŒèŠ‚ç‚¹é—´é€šè¿‡tcpé€šä¿¡

**BTCç½‘ç»œçš„ç›®æ ‡ï¼š**ç®€å•ï¼Œé²æ£’(robust)è€Œä¸æ˜¯é«˜æ•ˆ(efficient),æ¯ä¸ªèŠ‚ç‚¹ç»´æŠ¤é‚»å±…èŠ‚ç‚¹(éšæœºï¼Œä¸å—åº•å±‚æ‹“æ‰‘ç»“æ„å½±å“)çš„é›†åˆï¼Œæ¶ˆæ¯åœ¨ç½‘ç»œä¸­ä¼ æ’­é‡‡å–floodingçš„æ–¹å¼(èŠ‚ç‚¹ç¬¬ä¸€æ¬¡æ”¶åˆ°æ¶ˆæ¯ï¼Œè½¬å‘ï¼ŒåŒæ—¶è®°å½•æ¶ˆæ¯å·²ç»æ”¶åˆ°ï¼Œä¸‹æ¬¡å†æ”¶åˆ°æ—¶ï¼Œä¸ç”¨å†è½¬å‘)

æ¯”ç‰¹å¸ç³»ç»Ÿä¸­ç»´æŠ¤ä¸€ä¸ªç­‰å¾…å†™å…¥é“¾ä¸Šäº¤æ˜“çš„é›†åˆï¼Œç¬¬ä¸€æ¬¡æ”¶åˆ°ï¼Œè½¬å‘(åˆæ³•)ï¼Œä»¥åå†æ”¶åˆ°æ—¶ï¼Œå°±ä¸ä¼šå†è½¬å‘ï¼Œé¿å…åœ¨ç½‘ç»œä¸Šæ— é™ä¼ è¾“ä¸‹å»

BTCåè®®å¯¹åŒºå—å¤§å°çš„é™åˆ¶ä¸º1M

best effortï¼Œä¸€ä¸ªäº¤æ˜“ä¸ä¸€å®šè®©æ‰€æœ‰èŠ‚ç‚¹éƒ½æ”¶åˆ°ï¼Œé¡ºåºä¹Ÿä¸ä¸€å®šä¸€æ ·ï¼Œæœ‰äº›èŠ‚ç‚¹å¯èƒ½è½¬å‘é”™è¯¯çš„äº¤æ˜“

---

## BTC-æŒ–çŸ¿éš¾åº¦çš„è°ƒæ•´

$difficulty=\frac{difficulty\_1\_target}{target}$

åˆ†å­æ˜¯å½“éš¾åº¦ä¸º1ï¼ˆæœ€ä½ï¼‰çš„æ—¶å€™çš„ç›®æ ‡é˜ˆå€¼ï¼Œæ˜¯ä¸€ä¸ªå¾ˆå¤§çš„æ•°

æŒ–çŸ¿éš¾åº¦ä½ï¼Œå‡ºå—æ—¶é—´å¤ªçŸ­å¯¼è‡´ï¼šè¿™ä¸ªåŒºå—åœ¨ç½‘ç»œä¸Šæ¥ä¸åŠå¹¿æ’­ï¼Œä½¿å¾—å¤šåˆ†å‰å˜æˆå¸¸æ€ï¼Œä¸€æ—¦å‡ºç°å¤šåˆ†å‰ï¼Œå–„æ„çš„ç®—åŠ›è¢«åˆ†æ•£ï¼Œè€Œæ¶æ„ç®—åŠ›å¯ä»¥é›†ä¸­åœ¨ä¸€ä¸ªåˆ†å‰ä¸Šä½¿å¾—å…¶ä¸æ–­å»¶ä¼¸æˆä¸ºæœ€é•¿åˆæ³•é“¾ï¼Œä½¿å¾—51% attackçš„æ•°å­—ä¼šå˜å°

æ¯2016ä¸ªåŒºå—è°ƒæ•´ä¸€ä¸‹éš¾åº¦ï¼Œå¤§æ¦‚æ˜¯14å¤©ä¸€æ¬¡ï¼Œ$target=target\times \frac{actual~time}{expected~time}$

ä»£ç å†™åœ¨æ¯”ç‰¹å¸æºç ä¸­ï¼ŒéªŒè¯åŒºå—æ—¶ä¼šéªŒè¯ç›®æ ‡é˜ˆå€¼çš„å‹ç¼©ç¼–ç ï¼ˆnBitsï¼‰ï¼Œæ¶æ„èŠ‚ç‚¹æ— æ³•æ‰§è¡Œè°ƒæ•´nBitsæ¥é™ä½éš¾åº¦å› ä¸ºåˆ«çš„åŒºå—éªŒè¯ä¼šé€šä¸è¿‡

æ¯”ç‰¹å¸æˆåŠŸå¯èƒ½æºäºä»–çš„ä¸å¤ªå®ç”¨ï¼Œè®¾è®¡æ¯”è¾ƒä¿å®ˆï¼Œç›®å‰å‚æ•°è¿˜ç®—æ¯”è¾ƒåˆç†

## BTC-æŒ–çŸ¿

### èŠ‚ç‚¹æ„æˆ

å…¨èŠ‚ç‚¹ï¼š

- ä¸€ç›´åœ¨çº¿

- åœ¨æœ¬åœ°ç¡¬ç›˜ä¸­ç»´æŠ¤å®Œæ•´çš„åŒºå—é“¾ä¿¡æ¯

- åœ¨å†…å­˜ä¸­ç»´æŠ¤UTXOé›†åˆï¼Œä»¥ä¾¿å¿«é€Ÿæ£€éªŒäº¤æ˜“çš„æ­£ç¡®æ€§

- ç›‘å¬æ¯”ç‰¹å¸ç½‘ç»œä¸Šçš„äº¤æ˜“ä¿¡æ¯ï¼ŒéªŒè¯æ¯ä¸ªäº¤æ˜“çš„åˆæ³•æ€§

- å†³å®šå“ªäº›äº¤æ˜“ä¼šè¢«æ‰“åŒ…åˆ°åŒºå—é‡Œ

- ç›‘å¬åˆ«çš„çŸ¿å·¥æŒ–å‡ºæ¥çš„åŒºå—ï¼ŒéªŒè¯å…¶åˆæ³•æ€§

    - äº¤æ˜“åˆæ³•ï¼ˆåŒ…æ‹¬é“¸å¸çš„é‡‘é¢ï¼‰

    - æ˜¯å¦ç¬¦åˆéš¾åº¦è¦æ±‚ï¼Œå³block headerå–hashå‰é¢æ˜¯å¦æœ‰è¶³å¤Ÿå¤šçš„0

        ï¼Œæ£€æŸ¥éš¾åº¦ç›®æ ‡é˜ˆå€¼æ˜¯å¦æ­£ç¡®

    - æ˜¯å¦æ¥åœ¨æœ€é•¿åˆæ³•é“¾ä¸Š

- æŒ–çŸ¿

    - æ²¿ç€å“ªæ¡é“¾
    - ç­‰é•¿é€‰æ‹©å“ªæ¡é“¾æŒ–

è½»èŠ‚ç‚¹(Simplified Payment Verification)ï¼š

- ä¸æ˜¯ä¸€ç›´åœ¨çº¿
- ä¸ç”¨ä¿å­˜æ•´ä¸ªåŒºå—é“¾ï¼Œåªè¦ä¿å­˜æ¯ä¸ªåŒºå—çš„å—å¤´
- ä¸ç”¨ä¿å­˜å…¨éƒ¨äº¤æ˜“ï¼Œåªä¿å­˜ä¸è‡ªå·±ç›¸å…³çš„äº¤æ˜“
- æ— æ³•æ£€éªŒå¤§å¤šæ•°äº¤æ˜“çš„åˆæ³•æ€§ï¼Œåªèƒ½æ£€éªŒä¸è‡ªå·±ç›¸å…³çš„é‚£äº›äº¤æ˜“çš„åˆæ³•æ€§
- æ— æ³•æ£€æµ‹ç½‘ä¸Šå‘å¸ƒçš„åŒºå—çš„æ­£ç¡®æ€§
- å¯ä»¥éªŒè¯æŒ–çŸ¿çš„éš¾åº¦
- åªèƒ½æ£€æµ‹å“ªä¸ªæ˜¯æœ€é•¿é“¾ï¼Œä¸çŸ¥é“å“ªä¸ªæ˜¯æœ€é•¿åˆæ³•é“¾

å½“ç›‘å¬åˆ°æœ‰äººæŒ–å‡ºä¸€ä¸ªåŒºå—ä¹‹åï¼Œè‡ªå·±éœ€è¦åœæ­¢å½“å‰çš„æŒ–çŸ¿ç„¶åé‡æ–°æ‰“åŒ…äº¤æ˜“ã€åŒºå—ç„¶åå¼€å§‹æŒ–çŸ¿â€”â€”å¹¶ä¸å¯æƒœï¼Œå› ä¸ºæ— è®°å¿†æ€§ memoryless / progress freeï¼Œæ— è®ºç»§ç»­æŒ–è¿˜æ˜¯é‡æŒ–ï¼Œæ¦‚ç‡ç›¸åŒ

æ¯”ç‰¹å¸çš„å®‰å…¨æœ‰å¯†ç å­¦ï¼ˆæ— æ³•ä¼ªé€ ç­¾åå’Œèº«ä»½ï¼‰ä¸å…±è¯†æœºåˆ¶ä¿è¯ï¼Œå‰æå¤§éƒ¨åˆ†èŠ‚ç‚¹æ˜¯æ²¡æœ‰æ¶æ„çš„



### æŒ–çŸ¿è®¾å¤‡æ¼”åŒ– 



-  ç”¨ç¬”è®°æœ¬CPUï¼ˆå†…å­˜çš„èµ„æºé—²ç½®ï¼‰ 
- GPU(é€šç”¨å¹¶è¡Œè®¡ç®—ï¼Œåªåˆ©ç”¨æ•´å‹è®¡ç®—ï¼Œæµ®ç‚¹å¯„å­˜å™¨ç­‰é—²ç½®)
- ç›®å‰æŒ–çŸ¿å¸¸ç”¨ASICï¼ˆApplication Specific Integrated Circuitï¼‰èŠ¯ç‰‡ï¼Œåªé€‚ç”¨äºä¸€ç§mining puzzleã€‚æœ‰äº›å¸çš„mining puzzleä¼šè®¾ç½®æˆå’Œä¸€ä¸ªæ¯”è¾ƒç«çš„å¸ä¸€æ ·ï¼Œè¿™ç§æƒ…å†µæˆä¸ºmerge miningã€‚

æœ‰äººè®¤ä¸ºä¼šè¿èƒŒå»ä¸­å¿ƒåŒ–çš„åˆè¡· -> alternative mining puzzle -> ASIC resistance -> å®¶ç”¨è®¡ç®—æœºä¹Ÿå¯ä»¥æŒ–çŸ¿



### çŸ¿æ± 

æŒ–çŸ¿çš„ä¸€ä¸ªè¶‹åŠ¿çš„å¤§å‹çŸ¿æ± çš„å‡ºç°

- ç»¼åˆæ‰€æœ‰çŸ¿å·¥éœ€è¦10é’Ÿä¸€ä¸ªåŒºå—ï¼Œå•ä¸ªçŸ¿å·¥å¯èƒ½è¦1 - 2 å¹´æ‰å¯ä»¥ï¼Œç›¸å½“äºä¸­å½©ç¥¨
- å•ä¸ªçŸ¿å·¥é™¤äº†æŒ–çŸ¿è¿˜éœ€è¦æ‰¿æ‹…å…¨èŠ‚ç‚¹çš„å…¶ä»–è´£ä»»ä»»åŠ¡é‡ï¼ˆASICåªèƒ½è®¡ç®—hashï¼Œæ— æ³•æ‰§è¡ŒåŒºå—é“¾å…¶ä»–åŠŸèƒ½ï¼‰
- è§£å†³å•ä¸ªçŸ¿å·¥æ”¶å…¥ä¸ç¨³å®šé—®é¢˜

**pool managerï¼š æ‰¿æ‹…å…¨èŠ‚ç‚¹çš„å…¶ä»–è´£ä»»ï¼ˆç›‘å¬äº¤æ˜“ã€æ‰“åŒ…åŒºå—ã€ç›‘å¬æ–°åŒºå—äº§ç”Ÿï¼‰**

**pool miner: åªè´Ÿè´£è®¡ç®—hash**

åˆ†é…é—®é¢˜

- å¤§æ–°æ•°æ®ä¸­å¿ƒ - åŒä¸€æœºæ„ï¼Œä¸å­˜åœ¨åˆ†é…é—®é¢˜
- åˆ†å¸ƒå¼ (ä¸å±äºåŒä¸€æœºæ„)ï¼Œ æŒ‰ç…§å·¥ä½œé‡å¤§å°åˆ†é…
    - é™ä½æŒ–çŸ¿éš¾åº¦ , çŸ¿ä¸»æ£€æŸ¥æ¯ä¸ªçŸ¿å·¥æäº¤shareã€ almost valid block

çŸ¿æ± ç®—åŠ›åˆ†å¸ƒï¼šæ•°æ®æ¯”è¾ƒè€

![image-20240616112435127](åŒºå—é“¾æŠ€æœ¯ä¸åº”ç”¨.assets/image-20240616112435127.png)



å±å®³ï¼š å‘åŠ¨ 51% æ”»å‡»æ›´åŠ å®¹æ˜“

å¦‚æœæŸä¸ªçŸ¿æ± å¾—åˆ°51%ç®—åŠ›ï¼Œå°±å¯ä»¥ä½¿ç”¨åˆ†å‰æ”»å‡»ã€Boycottï¼ˆå°é”äº¤æ˜“ï¼Œæ‰€æœ‰å’ŒæŸäººæœ‰å…³çš„äº¤æ˜“å…¨éƒ¨å›æ»šï¼Œä¸éœ€è¦ç­‰å¾…6ä¸ªconfirmationï¼Œè¿™æ ·åˆ«çš„çŸ¿å·¥ä¹Ÿä¼šä¸æ‰“åŒ…å’Œè¯¥äººæœ‰å…³çš„äº¤æ˜“ï¼Œé€¼è¿«ç«™é˜Ÿï¼‰ï¼Œä½†ä¸èƒ½æŠŠåˆ«äººçš„é’±è½¬èµ°ï¼ˆå› ä¸ºæ²¡æœ‰åˆ«äººçš„ç§é’¥ï¼‰



## BTC-è„šæœ¬ 



![image-20240616113556573](åŒºå—é“¾æŠ€æœ¯ä¸åº”ç”¨.assets/image-20240616113556573.png)



åŸºäºæ ˆçš„è¯­è¨€(stack base language),bitcoin script 

```json
"result": {
    "txid":"921a...dd24",
    "hash":"921a...dd24",
    "version":1,
    "size":226,
    "locktime":0,//è®¾å®šäº¤æ˜“ç”Ÿæ•ˆæ—¶é—´
    "vin":[...],
	"vout":[...],
	"blockhash":"00000000002c510d...5c0b",//åŒºå—hash
	"confirmations":23,//ç¡®è®¤ä¿¡æ¯
	"time":1530846727,//äº¤æ˜“äº§ç”Ÿæ—¶é—´
	"blocktime":1530846727//åŒºå—äº§ç”Ÿæ—¶é—´
}
// locktimeä¸º0è¡¨ç¤ºç«‹åˆ»ç”Ÿæ•ˆ

"vin": [{
    "txid":"",//è¾“å‡ºæ¥æºçš„äº¤æ˜“çš„hashåœ°å€
    "vout":0,//æŒ‡å®šæ¥æºäº¤æ˜“çš„è¾“å‡ºç´¢å¼•
    " ": {//inputscript
        "asm":"",
        "hex":""
    }
}]
// ä¸Šé¢voutçš„å€¼è¡¨ç¤ºæ˜¯txidäº¤æ˜“çš„ç¬¬å‡ ä¸ªè¾“å‡º

"vout": [{
    "value":0.1,//è¾“å‡ºé‡‘é¢ BTC
    "n":0,//è¡¨ç¤ºäº¤æ˜“çš„ç¬¬å‡ ä¸ªè¾“å‡º
    "scriptPubKey": {
        "asm":"DUP HASH160 628e... EQUALVERIFY CHECKSIG",
        "hex":"76a9...",
        "reqSigs":1,
        "type":"pubkeyhash",
        "addresses":["...."]
    }
}]
// ä¸Šé¢nè¡¨ç¤ºä¸ºå½“å‰è¾“å‡ºçš„ç¬¬å‡ ä¸ªï¼Œasmè¾“å‡ºè„šæœ¬çš„å†…å®¹ï¼ŒreqSigsè¡¨ç¤ºéœ€è¦çš„ç­¾åæ•°é‡
```

![](åŒºå—é“¾æŠ€æœ¯ä¸åº”ç”¨.assets/script.png)

æŸä¸ªåŒºå—Açš„è¾“å…¥æ¥æºäºåŒºå—Bçš„è¾“å‡ºï¼Œé‚£ä¹ˆå°†Açš„input scriptå’ŒBçš„output scriptï¼ˆæ³¨æ„**ä¸æ˜¯**Açš„output scriptï¼‰æ‹¼æ¥åœ¨ä¸€èµ·ï¼Œå…ˆæ‰§è¡Œå‰è€…ï¼Œåæ‰§è¡Œåè€…ï¼Œå¦‚æœç»“æœä¸ºtrueå°±è¡¨ç¤ºåˆæ³•

è¾“å…¥è¾“å‡ºè„šæœ¬å‡ ç§ç±»å‹ï¼š

- P2PK (Pay to Public Key)

    - input script
        - PUSHDATA (Sigï¼Œä»˜æ¬¾äººç§é’¥å¯¹è¾“å…¥è„šæœ¬è¿™ä¸ªäº¤æ˜“çš„ç­¾å)
    - output script
        - PUSHDATA (PubKeyï¼Œä»˜æ¬¾äººå…¬é’¥)
        - CHECKSIG(æ£€æŸ¥ç­¾å)
    - ![image-20240616125935389](åŒºå—é“¾æŠ€æœ¯ä¸åº”ç”¨.assets/image-20240616125935389.png)
    - ![image-20240616130001619](åŒºå—é“¾æŠ€æœ¯ä¸åº”ç”¨.assets/image-20240616130001619.png)
    - ![image-20240616130044339](åŒºå—é“¾æŠ€æœ¯ä¸åº”ç”¨.assets/image-20240616130044339.png)

- P2PKH (Pay to Public Key Hash) æœ€å¸¸ç”¨

    - input script
        - PUSHDATA (Sig) å‹æ ˆ
        - PUSHDATA (PubKey) å‹æ ˆ
    - output script
        - DUP å¤åˆ¶ä¸€ä»½æ ˆé¡¶å¹¶å‹æ ˆ
        - HASH160 å¼¹å‡ºæ ˆé¡¶pubkeyå–hashå‹å…¥æ ˆ
        - PUSHDATA (PubKeyHash) å‹å…¥pubkeyhash
        - EQUALVERIFY å¼¹å‡ºæ ˆé¡¶ä¸¤ä¸ªhashå€¼æ˜¯å¦ç›¸ç­‰ï¼Œé˜²æ­¢æŸäººä»¥è‡ªå·±çš„å…¬é’¥é¡¶æ›¿
        - CHECKSIG æœ€åå°†sigå’Œpubkeyè¿›è¡Œcheckæ­£ç¡®å°±è¿”å›true
    - ![image-20240616130252445](åŒºå—é“¾æŠ€æœ¯ä¸åº”ç”¨.assets/image-20240616130252445.png)
    - ![image-20240616130357900](åŒºå—é“¾æŠ€æœ¯ä¸åº”ç”¨.assets/image-20240616130357900.png)

- P2SH (Pay to Script Hash)

    - input script

        - ...
        - PUSHDATA (Sig)
        - ...
        - PUSHDATA (serialized redeemScript)

    - output script

        - HASH160
        - PUSHDATA (redeemScriptHashï¼Œæ”¶æ¬¾äººæä¾›çš„è„šæœ¬çš„hash)
        - EQUAL

    - ç®€å•æ¥è¯´å°±æ˜¯å¦å¤–æœ‰ä¸€ä¸ªredeem scriptï¼ˆèµå›è„šæœ¬ï¼‰ï¼Œé¦–å…ˆæ‰§è¡Œinputå’Œoutputï¼Œæœ€åæ‰§è¡Œredeemçš„å†…å®¹

    - ä½¿ç”¨ P2SH å®ç° P2PK

        - ![image-20240616130914640](åŒºå—é“¾æŠ€æœ¯ä¸åº”ç”¨.assets/image-20240616130914640.png)

        - ![image-20240616131042819](åŒºå—é“¾æŠ€æœ¯ä¸åº”ç”¨.assets/image-20240616131042819.png)

        - ![image-20240616131123332](åŒºå—é“¾æŠ€æœ¯ä¸åº”ç”¨.assets/image-20240616131123332.png)

    - æ”¯æŒå¤šé‡ç­¾å

        -å°†input scriptä¸­æ”¹æˆ

        - false (Bitcoinçš„å®ç°BUGï¼Œè¿™é‡Œå¤šå‹å…¥ä¸€ä¸ªæ²¡ç”¨çš„å…ƒç´ )
        - PUSHDATA (Sig_1)
        - ...
        - PUSHDATA (Sig_M)
        - PUSHDATA (serialized redeemScript)

        å°†redeemScriptå†™æˆ

        - M è¡¨ç¤ºæ€»çš„ç­¾åæ•°
        - PUSHDATA (pubkey_1)
        - ...
        - PUSHDATA (pubkey_N)
        - N
        - CHECKMULTISIG

    - ![image-20240616131606818](åŒºå—é“¾æŠ€æœ¯ä¸åº”ç”¨.assets/image-20240616131606818.png)

    - ![image-20240616131835975](åŒºå—é“¾æŠ€æœ¯ä¸åº”ç”¨.assets/image-20240616131835975.png)

    - ![image-20240616132141283](åŒºå—é“¾æŠ€æœ¯ä¸åº”ç”¨.assets/image-20240616132141283.png)

- Proof of Burn

    - output script
        - RETURN [zero or more ops or text]
        - è¿™ç§å½¢å¼çš„outputè¢«ç§°ä¸ºProvably Unspendable/Prunable Outputs
    - è„šæœ¬è¯´æ˜ï¼šreturnç›´æ¥è¿”å›falseï¼Œè¿™ä¸ªoutputæ— æ³•è¢«èŠ±å‡ºå»ï¼ŒUTXOå¯ä»¥å‰ªæ
    - åº”ç”¨
        - AltCoin (Alternative Coin) é”€æ¯Bitcoinè·å¾—å°å¸
        - èŠ±è´¹éå¸¸å°‘çš„BTCå°†æŸäº›å†…å®¹å–hashæ”¾åˆ°returnåé¢ï¼Œè¿™æ ·å°±èƒ½æ”¾åˆ°åŒºå—é“¾ä¸Š ï¼ˆcoinbaseä¸­ä¹Ÿæ˜¯éšæ„è®°ä¸œè¥¿çš„ï¼Œä½†æ˜¯åªæœ‰è·å¾—è®°è´¦æƒçš„èŠ‚ç‚¹æ‰èƒ½å†™ä¸œè¥¿ï¼‰

## BTC-åˆ†å‰

- state fork  çŠ¶æ€åˆ†å‰ï¼Œæ„è§åˆ†æ­§
    - åŒ…æ‹¬forking attackï¼Œä¹Ÿè¢«ç§°ä¸ºdeliberate(è“„æ„) fork
- protocol fork åè®®åˆ†å‰
    - ä¸åŒåè®®é€ æˆçš„åˆ†å‰ï¼Œæ²¡æœ‰åŠæ³•ä¿è¯ç³»ç»Ÿæ‰€æœ‰è½¯ä»¶å‡çº§
    - è¿›ä¸€æ­¥åˆ†æˆhard forkå’Œsoft fork
    - hard fork
        - æ‰©å±•æ–°çš„ç‰¹æ€§ï¼ˆå¦‚ä¿®æ”¹block size limitä¸º4Mï¼‰æ—¶å¦‚æœä¸è®¤å¯æ–°çš„ç‰¹æ€§å°±ä¼šäº§ç”Ÿç¡¬åˆ†å‰
        - æ—§èŠ‚ç‚¹åœ¨åŸæ¥çš„é“¾ä¸Šä¸æ–­å»¶ä¼¸ï¼Œæ–°èŠ‚ç‚¹åœ¨æ–°çš„é“¾ä¸Šå»¶ä¼¸ï¼Œäº§ç”Ÿæ°¸ä¹…æ€§çš„åˆ†å‰
        - å½“å‰äº¤æ˜“é€Ÿåº¦çº¦ä¸ºæ¯ç§’7ç¬”äº¤æ˜“ 1000000 / (250 * 60 *10) ç°å®ä¸­ä¿¡ç”¨å¡ç­‰æ¯”è¿™é«˜äº†å¥½å‡ ä¸ªæ•°é‡çº§
        - ç”±æ­¤ç¤¾åŒºåˆ†è£‚æˆä¸¤å¸®äººï¼Œä¸€ä¸ªå¸æ‹†æˆäº†ä¸¤ä¸ªå¸ï¼Œå„è‡ªæœ‰è‡ªå·±çš„chain id ,å„æœ‰å„çš„å¸
        - å¿…é¡»æ‰€æœ‰èŠ‚ç‚¹æ›´æ–°æ‰æ²¡æœ‰åˆ†å‰
    - soft fork
        - ä¸´æ—¶çš„åˆ†å‰ï¼ˆå¦‚ä¿®æ”¹block sizeä¸º1Mï¼‰
        - æ—§èŠ‚ç‚¹ä¼šæ”¾å¼ƒæ—§é“¾ï¼Œåœ¨æ–°é“¾ä¸Šå»¶ä¼¸ï¼Œä½†æ˜¯æ­¤æ—¶æ–°èŠ‚ç‚¹åˆä¸ä¼šè®¤å½“å‰é“¾ä¸ºæœ€é•¿åˆæ³•é“¾è€Œæ–°å¼€ä¸€ä¸ªåˆ†å‰ï¼Œä½¿å¾—æ—§èŠ‚ç‚¹ä¸€ç›´æ˜¯ç™½æŒ–
        - æœ€ç»ˆè¿˜æ˜¯ä¼šå˜æˆä¸€æ¡é“¾
        - ä¾‹å­ï¼šç»™åŸæ¥çš„æŸäº›åŸŸä¸€äº›æ–°çš„å«ä¹‰ï¼Œæ¯”å¦‚ç»™coinbaseåŸŸå¢åŠ å«ä¹‰extra nonceï¼Œnonce+UTXOçš„æ ¹hash, P2SH
        - ç³»ç»ŸåŠæ•°èŠ‚ç‚¹æ›´æ–°å³å¯
        - ![image-20240616134336154](åŒºå—é“¾æŠ€æœ¯ä¸åº”ç”¨.assets/image-20240616134336154.png)

## BTC-è¯¾å ‚é—®ç­”

- å¦‚æœæ”¶æ¬¾äººæ²¡æœ‰è¿æ¥åˆ°BTCç½‘ç»œï¼Ÿ

    - æ²¡æœ‰å…³ç³»
- OP_RETURNæ°¸è¿œè¿”å›falseä¸ºå•¥ä¼šå†™åˆ°åŒºå—é“¾ä¸Šï¼Ÿ

    - å› ä¸ºè¿™ä¸ªRETURNè¯­å¥æ˜¯å†™åœ¨output scriptï¼Œå› æ­¤åœ¨éªŒè¯è¿™ç¬”äº¤æ˜“çš„æ—¶å€™å¹¶ä¸æ‰§è¡Œ
- äº¤æ˜“è´¹ç»™å“ªä½ï¼Ÿ

    - äº¤æ˜“è´¹ç­‰äºæ€»è¾“å…¥å‡æ€»è¾“å‡ºï¼Œå‰©ä¸‹çš„ç›´æ¥ç»™æŒ–åˆ°çš„çŸ¿å·¥å³å¯

## BTC-åŒ¿åæ€§

anonymity

pseudonymity (åŒ–å)ï¼ŒåŒ¿åæ€§ä¸å¦‚çº¸å¸é«˜äºé“¶è¡Œ

å¯ä»¥é€šè¿‡äº¤æ˜“ä¿¡æ¯å°†è¾“å…¥è¾“å‡ºé’±åŒ…å…³è”ä¸‹æ¥

![image-20240616142338666](åŒºå—é“¾æŠ€æœ¯ä¸åº”ç”¨.assets/image-20240616142338666.png)

ä¸åŒè´¦æˆ·ä¹‹é—´å¯ä»¥å»ºç«‹å…³è”ã€BTCå’Œç°å®ä¸–ç•Œä¹Ÿå¯ä»¥å½¢æˆå…³è” ()

- åœ¨network layerï¼ˆP2P  ï¼‰ä¸Šå®ç°åŒ¿åæ€§ï¼šä½¿ç”¨TOR,ä¸­é—´èŠ‚ç‚¹åªçŸ¥é“ä¸Šä¸€ä¸ªèŠ‚ç‚¹è½¬å‘

- åœ¨application layerä¸Šå®ç°åŒ¿åæ€§ï¼šcoin mixingã€åœ¨çº¿é’±åŒ…æœ¬èº«å¯èƒ½å¸¦æœ‰coin mixingåŠŸèƒ½ã€äº¤æ˜“æ‰€å¤©ç„¶æœ‰coin mixingåŠŸèƒ½ï¼ˆå¦‚æœäº¤æ˜“æ‰€ä¸æš´éœ²æå¸å­˜å¸çš„è®°å½•ï¼‰

## è¡¥-é›¶çŸ¥è¯†è¯æ˜

è¯æ˜è€…å‘éªŒè¯è€…è¯æ˜ä¸€ä¸ªé™ˆè¿°æ˜¯æ­£ç¡®çš„ï¼Œè€Œæ— éœ€é€éœ²è¯¥é™ˆè¿°æ˜¯æ­£ç¡®çš„å¤–ä»»ä½•ä¿¡æ¯

æ•°å­¦åŸºç¡€ï¼š**åŒæ€éšè—**

- å¦‚æœ$x,y$ä¸åŒï¼Œé‚£ä¹ˆåŠ å¯†å‡½æ•°å€¼$E(x)$å’Œ$E(y)$ä¹Ÿä¸åŒ 
- ç»™å®š$E(x)$ï¼Œå¾ˆéš¾åå¯¹å‡º$x$çš„å€¼ï¼ˆç±»ä¼¼hidingï¼‰
- åŒæ€è¿ç®—ï¼š
    - åŒæ€åŠ æ³•ï¼š$E(x)$  $E(y)$ => $E(x+y)$
    - åŒæ€ä¹˜æ³•ï¼š$E(x)$  $E(y)$ => $E(xy)$
    - æ‰©å±•åˆ°å¤šé¡¹å¼

![image-20240616144613236](åŒºå—é“¾æŠ€æœ¯ä¸åº”ç”¨.assets/image-20240616144613236.png)

![image-20240616145008902](åŒºå—é“¾æŠ€æœ¯ä¸åº”ç”¨.assets/image-20240616145008902.png)

ä¸ºåŒ¿åæ€§è®¾è®¡çš„  åŠ å¯†è´§å¸ï¼šé›¶å¸zerocoinå’Œé›¶é’zerocash 

- é€šè¿‡é›¶çŸ¥è¯†è¯æ˜æ˜¯åŒºå—é“¾ä¸Šå­˜åœ¨çš„åˆæ³•çš„å¸ï¼Œä¸éœ€è¦çŸ¥é“å¸çš„æ¥æº

![image-20240616145052470](åŒºå—é“¾æŠ€æœ¯ä¸åº”ç”¨.assets/image-20240616145052470.png)

## BTC-å¼•èµ·çš„æ€è€ƒ

- hash pointeråªæœ‰æœ¬åœ°çš„åœ°å€ï¼Œå‘å¸ƒåˆ°åŒºå—é“¾ç½‘ç»œä¸Šä¼šå’‹æ ·ï¼Ÿ

    ç½‘ç»œä¸Šæ²¡æœ‰æŒ‡é’ˆï¼Œåªæœ‰hashï¼Œå…¨èŠ‚ç‚¹ç»´æŠ¤ä¸€ä¸ªæ•°æ®åº“ä¿å­˜`(key, value)`ï¼Œå¸¸ç”¨çš„æ˜¯levelDB

- åŒºå—æ‹

    å…±äº«è´¦æˆ·ä¸è¦ä½¿ç”¨æˆªæ–­ç§é’¥(private keyç ´è§£éš¾åº¦å¤§å¤§é™ä½ï¼Œå¸æ°¸ä¹…ä¿å­˜åœ¨UTXOï¼Œå¯¹çŸ¿å·¥ä¸å‹å¥½)ï¼Œä½¿ç”¨å¤šé‡ç­¾åMULTISIG

- åˆ†å¸ƒå¼å…±è¯† 

    BTCå®é™…ä¸Šä¹Ÿæ²¡æœ‰å–å¾— çœŸæ­£çš„å…±è¯†ï¼Œä½†æ˜¯å®é™…å’Œç†è®ºæ˜¯ä¸ä¸€æ ·çš„ 

    **ä¸è¦è¢«å­¦æœ¯ç•Œçš„æ€ç»´é™åˆ¶äº†å¤´è„‘ï¼Œä¸è¦è¢«ç¨‹åºå‘˜çš„æ€ç»´é™åˆ¶äº†æƒ³è±¡åŠ›**

- é‡å­è®¡ç®—

    æ¯”ç‰¹å¸æœ‰ç”Ÿä¹‹å¹´ä¸ä¸€å®šå¯¹å…¶äº§ç”Ÿå®è´¨æ€§å¨èƒï¼Œé¦–å…ˆå†²å‡»ä¼ ç»Ÿé‡‘èä¸š

    - åŠ å¯† ä¿è¯ä¿¡æ¯å®Œæ•´æ€§

    - å–hash ä¼šé€ æˆä¿¡æ¯æŸå¤±ï¼Œæ²¡æœ‰åŠæ³•é€†æ¨
    - å³ä½¿å…¬é’¥ä¹Ÿä¸è¦éšä¾¿æ³„éœ²

---

## ETH-æ¦‚è¿°

ETHç›¸è¾ƒäºBTCåˆ›æ–°ä¹‹å¤„ï¼š

- å‡ºå—æ—¶é—´ åå‡ ç§’ï¼Œghost
- é‡æ–°è®¾è®¡äº†mining puzzleä¸ºmemory hardï¼ˆASIC resistanceï¼‰
- å°†æƒç›Šè¯æ˜proof of stakeå–ä»£å·¥ä½œé‡è¯æ˜
- æ”¯æŒæ™ºèƒ½åˆçº¦smart contractï¼Œå¢åŠ å»ä¸­å¿ƒåŒ–çš„åˆçº¦æ”¯æŒ
    - è·¨å›½åˆçº¦ï¼Œæ²¡æœ‰ä¸€ä¸ªç»Ÿä¸€çš„å¸æ³•ä½“åˆ¶ï¼Œé€šè¿‡å¸æ³•ç»´æŠ¤åˆçº¦æœ‰æ•ˆæ€§æ¯”è¾ƒå›°éš¾ï¼Œé€šè¿‡æŠ€æœ¯æ‰‹æ®µåˆ¶å®šè§„åˆ™ï¼Œåˆ©ç”¨ä¸å¯ç¯¡æ”¹æ€§

## ETH-è´¦æˆ·

BTCæœ‰æ‰¾é›¶åœ°å€ï¼Œå¿…é¡»ä¸€æ¬¡æ€§ä½¿ç”¨ä¹‹å‰å¾—åˆ°çš„BTCï¼Œå¦åˆ™å°±ä¼šå½“æˆæ‰‹ç»­è´¹ç»™çŸ¿å·¥

ETHä½¿ç”¨account-based ledgerï¼Œéœ€è¦æ˜¾å¼åœ°è®°å½•æ¯ä¸ªè´¦æˆ·æœ‰çš„ETH

å¯¹double spending attack(èŠ±é’±çš„äººä¸è¯šå®)æœ‰å¤©ç”Ÿçš„é˜²å¾¡æ€§

- ä¸ç”¨è®°å½•å¸çš„æ¥æºï¼ŒèŠ±äº†å°±ç›´æ¥åœ¨ä½™é¢ä¸­æ‰£é™¤å³å¯

ä½†ä¼šé‡åˆ°replay attack(æ”¶é’±çš„äººä¸è¯šå®)é‡æ”¾æ”»å‡»ï¼šæ”¶æ¬¾äººå°†æŸä¸ªäº¤æ˜“å¤šæ¬¡å¹¿æ’­

- A->B ,BæŠŠäº¤æ˜“å¤šæ¬¡å¹¿æ’­ï¼ŒèŠ‚ç‚¹æ¥å—å¹¶æ‰£é™¤Aè´¦æˆ·ä½™é¢
- è§£å†³æ–¹æ³•ï¼šåœ¨äº¤æ˜“ä¸­åŠ å…¥nonceè¡¨ç¤ºæŸè´¦æˆ·çš„äº¤æ˜“ç¼–å·ï¼ˆä»0åˆ°æ­£æ— ç©·ï¼‰
- ![](åŒºå—é“¾æŠ€æœ¯ä¸åº”ç”¨.assets/resistence-replay-nonce.png)

ETHä¸­æœ‰ä¸¤ç±»è´¦æˆ·ï¼š

- externally owned account
    - balance
    - nonce è®¡æ•°å™¨ /counter /sequence number
- smart contract account åˆçº¦è´¦æˆ·
    - ä¸èƒ½ä¸»åŠ¨åœ°å‘èµ·äº¤æ˜“,æ‰€æœ‰äº¤æ˜“å¿…é¡»ç”±EOAå‘èµ·ï¼Œä½†å¯ä»¥è°ƒç”¨å¦å¤–ä¸€ä¸ªåˆçº¦
    - é™¤äº†ä¸Šé¢ä¸¤ä¸ªä¸œè¥¿ä¹‹å¤–è¿˜æœ‰ï¼šcodeå’Œstorage(åˆ›å»ºåˆçº¦ä¼šæ”¶åˆ°ä¸€ä¸ªåœ°å€ï¼Œå³å¯è°ƒç”¨)
    - bitcoin->éšç§ä¿æŠ¤ï¼ŒETH->åˆçº¦->ç¨³å®šçš„èº«ä»½

## ETH-çŠ¶æ€æ ‘

ETHè´¦æˆ·160bitï¼Œ20å­—èŠ‚ï¼Œ40ä¸ªåå…­è¿›åˆ¶æ•°

ETHéœ€è¦ç»´æŠ¤addråˆ°stateçš„æ˜ å°„    addr -> state

- å¦‚æœä½¿ç”¨hashè¡¨(æ’å…¥ï¼Œæ›´æ”¹ï¼ŒæŸ¥è¯¢æ•ˆç‡é«˜)ç»´æŠ¤ä¸Šè¿°æ˜ å°„(å°†hash tableä¸­çš„æ•°æ®ç»´æŠ¤ä¸ºä¸€é¢—Merkle Treeï¼Œblock header ä¸­å­˜å‚¨Merkle root) 
    1. ä½¿ç”¨å•çº¯çš„hashè¡¨æ— æ³•è¯æ˜è´¦æˆ·ä½™é¢ç­‰çŠ¶æ€æ˜¯å¦è¢«ç¯¡æ”¹
    2. Merkle Proof (è¯æ˜è´¦æˆ·ä½™é¢)
        -  å› ä¸ºäº¤æ˜“çš„æ—¶å€™stateä¼šå‘ç”Ÿæ”¹å˜ï¼Œä¹Ÿå°±æ˜¯è¯´Merkle Proofæ— æ³•æˆåŠŸï¼ˆMerkle Tree Rootæ˜¯ä¸ºäº†ä¿è¯æ‰€æœ‰èŠ‚ç‚¹çš„ä¸€è‡´æ€§è€Œå¿…é¡»ä½¿ç”¨çš„æ•°æ®ç»“æ„ï¼‰ï¼Œå†…å®¹æ”¹å˜å¿…ç„¶å¯¼è‡´Merkle Tree Rootå‘ç”Ÿæ”¹å˜ï¼Œéœ€è¦é‡æ–°ç»„ç»‡Merkle Treeï¼Œè€Œè´¦æˆ·æ•°é‡æå¤§ï¼Œé‡æ–°ç»„ç»‡ä»£ä»·æå¤§  (bitcoinç³»ç»Ÿä¸­ç»´æŠ¤äº¤æ˜“çš„Merkle Tree,ä½†ä¸Šé™4000ä¸ª,è®¡ç®—æˆæœ¬è¾ƒä½)


- å¦‚æœç›´æ¥ä½¿ç”¨Merkle Treeæ¥æ„å»º
    1. æ²¡æœ‰æä¾›é«˜æ•ˆæŸ¥æ‰¾å’Œæ›´æ–°çš„æ–¹æ³•
    2. å¦‚æœä¸æ˜¯sorted Merkle treeï¼Œæ¯ä¸ªå…¨èŠ‚ç‚¹æ„å»ºçš„Merkle Treeå¶èŠ‚ç‚¹çš„é¡ºåºæ˜¯ä¸åŒï¼Œé‚£ä¹ˆæœ€åçš„root hashä¹Ÿå¯èƒ½ä¸åŒï¼ˆBTCä¸éœ€è¦æ’åºï¼Œæœ€åæ˜¯ç”±è·å¾—è®°è´¦æƒçš„èŠ‚ç‚¹å†³å®šï¼‰å¦‚æœæ˜¯sorted Merkle treeï¼Œæ–°äº§ç”Ÿçš„èŠ‚ç‚¹hashä¹‹åçš„å€¼ä¸€èˆ¬å°±æ’åœ¨å¶èŠ‚ç‚¹çš„ä¸­é—´å¯¼è‡´éœ€è¦é‡æ„Merkle Treeï¼Œä»£ä»·å¤ªå¤§äº†

**ETHä½¿ç”¨ç±»ä¼¼trieå­—å…¸æ ‘çš„æ•°æ®ç»“æ„(retrieval æ£€ç´¢)**

- ![](åŒºå—é“¾æŠ€æœ¯ä¸åº”ç”¨.assets/trie.png)

- ä¼˜ç‚¹
    - æ¯ä¸ªç»“ç‚¹çš„åˆ†æ”¯æ•°ç›®(branching factor)å–å†³äºkeyçš„èŒƒå›´ +ç»“æŸæ ‡å¿—ä½,0 - f +ç»“æŸæ ‡å¿—ç¬¦ 17
    - æŸ¥æ‰¾æ•ˆç‡ï¼šå–å†³äºkeyé•¿åº¦ 40 
    - ä¸ä¼šå‡ºç°ç¢°æ’
    - è¾“å…¥ä¸å˜ï¼Œé¡ºåºæ— æ‰€è°“ï¼Œæœ€åè¾“å‡ºçš„Trieæ˜¯åŒä¸€æ£µæ ‘
    - æ›´æ–°ï¼šä¸ç”¨è®¿é—®å…¶ä»–åˆ†æ”¯ï¼Œä¹Ÿä¸ç”¨éå†æ•´æ£µæ ‘
- ç¼ºç‚¹
    - å­˜å‚¨æµªè´¹

**trieç»è¿‡å‹ç¼©å¾—åˆ°Patricia Tree/Patricia Trieå‹ç¼©å‰ç¼€æ ‘**

- ![](åŒºå—é“¾æŠ€æœ¯ä¸åº”ç”¨.assets/par-trie.png)
- ç‰¹ç‚¹
    - æ ‘å˜æµ…äº†ï¼Œè®¿é—®æ¬¡æ•°å¤§å¹…é™ä½
    - æ–°æ’å…¥å•è¯ï¼ŒåŸæ¥çš„æ ‘å¯èƒ½ä¼šæ‰©å±•å¼€
    - å½“é”®å€¼ç¨€ç–çš„æ—¶å€™é€‚åˆè·¯å¾„å‹ç¼©ï¼Œä½¿ç”¨åè€…ï¼Œè€ŒETHéå¸¸ç¨€ç–ï¼ˆ$2^{160}$ï¼‰

**MPTï¼šMerkle Patricia Treeï¼Œå¯ä»¥é˜²ç¯¡æ”¹ï¼ŒMerkle Proofä»¥åŠéªŒè¯è´¦æˆ·æ˜¯å¦å­˜åœ¨**

- æ™®é€šæŒ‡é’ˆæ¢ä¸ºhashæŒ‡é’ˆ,å­˜å‚¨åœ°å€è½¬æ¢ä¸ºhashå€¼
- root hashä¸å˜ï¼Œæ•´ä¸ªè´¦æˆ·çŠ¶æ€éƒ½ä¸ä¼šè¢«ç¯¡æ”¹
- Merkle Proof  å‘é€æ‰€åœ¨åˆ†æ”¯ï¼Œè¯æ˜è´¦æˆ·ä½™é¢
- è¯æ˜æŸä¸ªè´¦æˆ·ä¸å­˜åœ¨

**ETHä½¿ç”¨Modified MPT**

- ![](åŒºå—é“¾æŠ€æœ¯ä¸åº”ç”¨.assets/modified-mpt.png)

ETHæ¯ä¸ªåŒºå—éƒ½è¦äº§ç”Ÿä¸€ä¸ªæ–°çš„MPTï¼Œä½†æ˜¯è¿™ä¸ªMPTå’Œä¹‹å‰çš„MPTå¤§éƒ¨åˆ†èŠ‚ç‚¹æ˜¯ç›¸åŒçš„ï¼Œåªéœ€è¦å¢åŠ æ–°çš„åˆ†æ”¯å³å¯ï¼Œä¸åœ¨åŸåœ°æ”¹çš„åŸå› ï¼šä¸´æ—¶æ€§åˆ†å‰å¾ˆå¸¸è§ï¼Œæœªèƒœå‡ºçš„èŠ‚ç‚¹éœ€è¦roll backï¼ŒåŒæ—¶æ™ºèƒ½åˆçº¦çš„å®ç°ä½¿å¾—é€šè¿‡äº¤æ˜“åæ¨ä¹‹å‰çš„çŠ¶æ€æ˜¯ä¸å¯èƒ½çš„ï¼Œæ‰€ä»¥éœ€è¦ä¿ç•™å†å²ä¿¡æ¯

![](åŒºå—é“¾æŠ€æœ¯ä¸åº”ç”¨.assets/mpt-share.png)

ä»¥å¤ªåŠä»£ç çš„æ•°æ®ç»“æ„

- header
    - ![](åŒºå—é“¾æŠ€æœ¯ä¸åº”ç”¨.assets/eth-header.png)

- all
    - ![](åŒºå—é“¾æŠ€æœ¯ä¸åº”ç”¨.assets/eth-block-all.png)

- extblock ç½‘ç»œä¸ŠçœŸæ­£å‘å¸ƒä¿¡æ¯
    - ![](åŒºå—é“¾æŠ€æœ¯ä¸åº”ç”¨.assets/ext-block.png)

çŠ¶æ€æ ‘ä¸­valueåºåˆ—åŒ–ä¹‹åå­˜å‚¨ï¼Œåºåˆ—åŒ–æ–¹æ³•ï¼šRecursive Length Prefix        **RLP**(æç®€ï¼Œä»…æ”¯æŒ nested array of  bytes)

## ETH-äº¤æ˜“æ ‘å’Œæ”¶æ®æ ‘

æ¯ä¸€ä¸ªäº¤æ˜“äº§ç”Ÿä¸€ä¸ªæ”¶æ®ï¼Œè®°å½•äº¤æ˜“çš„ç›¸å…³ä¿¡æ¯ï¼Œä¾¿äºå¿«é€ŸæŸ¥è¯¢æ‰§è¡Œç»“æœ

äº¤æ˜“æ ‘å’Œæ”¶æ®æ ‘éƒ½ä½¿ç”¨MPTï¼Œå®é™…ä¸Šåªæ˜¯ä¾¿äºé¡¹ç›®ç®¡ç†éƒ½é‡‡ç”¨MPTï¼Œä¹Ÿå¯ä»¥åªç”¨Merkle Treeï¼Œå› ä¸ºè¿™ä¸¤ç§æ ‘éƒ½æ˜¯å¯¹äºæŸä¸ªåŒºå—å»ºçš„ï¼Œå‰è€…çš„keyæ˜¯åœ¨å½“å‰åŒºå—ä¸­äº¤æ˜“åºå·

- MPTæ”¯æŒæŸ¥æ‰¾æ“ä½œï¼Œé€šè¿‡é”®å€¼ä»é¡¶å‘ä¸‹æ²¿ç€è¿™ä¸ªæ•°è¿›è¡ŒæŸ¥æ‰¾
    - è´¦æˆ·ï¼škey = account address
    - äº¤æ˜“æ ‘/æ”¶æ®æ ‘ï¼š key = äº¤æ˜“åœ¨å‘å¸ƒåŒºå—ä¸­çš„ä¿¡å·
- äº¤æ˜“æ ‘å’Œæ”¶æ®æ ‘åªæ˜¯æŠŠå‘å¸ƒåœ¨å½“å‰åŒºå—çš„äº¤æ˜“ç»„ç»‡èµ·æ¥(åŒºå—ä¸åŒºå—ä¹‹é—´ç‹¬ç«‹)ï¼ŒçŠ¶æ€æ•°è¦æ±‚åŒ…å«ç³»ç»Ÿä¸­æ‰€æœ‰è´¦æˆ·çš„çŠ¶æ€(å¤šä¸ªåŒºå—çš„çŠ¶æ€æ ‘æ˜¯å…±äº«çš„)
- ç”¨é€”
    - tx treeï¼šæä¾›Merkle Proof è¯æ˜æŸä¸ªäº¤æ˜“è¢«æ‰“åŒ…åˆ°åŒºå—ä¸­
    - receipt treeï¼šè¯æ˜æŸä¸ªäº¤æ˜“çš„æ‰§è¡Œç»“æœ

ä»¥å¤ªåŠä¸­æ”¯æŒæ›´é«˜æ•ˆçš„æŸ¥è¯¢æ“ä½œ

- æŸ¥è¯¢è¿‡å»10å¤©æ‰€æœ‰è·ŸæŸä¸ªæ™ºèƒ½åˆçº¦ç›¸å…³çš„äº¤æ˜“ä¿¡æ¯
    - æ‰«æ10å¤©å†…æ‰€æœ‰åŒºå—çš„äº¤æ˜“ä¿¡æ¯
        - å¤æ‚åº¦è¾ƒé«˜
        - å¯¹äºlight nodeåªæœ‰åŒºå—å¤´çš„ä¿¡æ¯ï¼Œä¸èƒ½æ‰«ææ‰€æœ‰äº¤æ˜“åˆ—è¡¨
- æŸ¥è¯¢è¿‡å»10å¤©ç¬¦åˆæŸç§ç±»å‹çš„æ‰€æœ‰äº‹ä»¶(ä¼—ç­¹ï¼Œå‘è¡Œæ–°å¸)

å¼•å…¥**Bloom Filter**å¸ƒéš†è¿‡æ»¤å™¨æ¥æé«˜æŸ¥è¯¢é€Ÿåº¦ï¼Œä½†å¯èƒ½å‡ºç°false positiveå‡é˜³æ€§ï¼Œä¸ä¼šå‡ºç° false negativeå‡é˜´æ€§(æ¼æŠ¥),ä¸€èˆ¬çš„Bloom Fiterä¸æ”¯æŒåˆ é™¤

![](åŒºå—é“¾æŠ€æœ¯ä¸åº”ç”¨.assets/bloom-filter.png)

æŸ¥è¯¢ï¼šå…ˆæŸ¥è¯¢åŒºå—å—å¤´ä¸­çš„bloom filter æœ‰ç›®æ ‡äº¤æ˜“ç±»å‹ï¼Œæ²¡æœ‰èˆå¼ƒï¼Œæœ‰çš„è¯æŸ¥è¯¢åŒºå—åŒ…å«äº¤æ˜“å¯¹åº”æ”¶æ®æ ‘ä¸­çš„bloom filterï¼Œå¿«é€Ÿè¿‡æ»¤å¤§é‡æ— å…³äº¤æ˜“

ETHè¿è¡Œè¿‡ç¨‹çœ‹åšæ˜¯äº¤æ˜“é©±åŠ¨çš„çŠ¶æ€æœºï¼ˆtransaction-dirven state machine , é€šè¿‡äº¤æ˜“é©±åŠ¨ç³»ç»Ÿä»å½“å‰çŠ¶æ€è½¬ç§»åˆ°ä¸‹ä¸€ä¸ªçŠ¶æ€ï¼ŒBTCä¹Ÿå¯ä»¥å°†UTXOçœ‹åšæ˜¯çŠ¶æ€ï¼‰ï¼Œ**çŠ¶æ€è½¬ç§»éœ€è¦æ˜¯ç¡®å®šæ€§çš„**

ä¸€äº›é—®é¢˜ï¼š

- ä»¥ä¸‹è¯´æ³•æ˜¯å¦å¯è¡Œï¼šåœ¨æ¯ä¸ªåŒºå—ä¸­ç»´æŠ¤ä¸€ä¸ªçŠ¶æ€æ ‘ï¼Œåªä¿å­˜å½“å‰åŒºå—ç”¨åˆ°çš„äº¤æ˜“è´¦æˆ·çŠ¶æ€ï¼Ÿ

    A -> B 10 ETHï¼Œéœ€è¦çŸ¥é“å½“å‰è´¦æˆ·A Bï¼Œçš„çŠ¶æ€
    
    æŸ¥æ‰¾æŸä¸ªè´¦æˆ·ä½™é¢æ¯”è¾ƒå›°éš¾ï¼›å¦‚æœè½¬è´¦è´¦æˆ·æ˜¯ä¸€ä¸ªä¸å­˜åœ¨çš„åŒºå—å°±éœ€è¦ä¸€ç›´è¿½æº¯åˆ°Genesisåˆ›ä¸–åŒºå—

**äº¤æ˜“æ ‘å’Œæ”¶æ®æ ‘çš„åˆ›å»ºè¿‡ç¨‹**

![](åŒºå—é“¾æŠ€æœ¯ä¸åº”ç”¨.assets/new-block.png)

**DeriveSha è·å–æ ¹hash**

![](åŒºå—é“¾æŠ€æœ¯ä¸åº”ç”¨.assets/derive-sha.png)

**Trieç»“æ„**

![](åŒºå—é“¾æŠ€æœ¯ä¸åº”ç”¨.assets/trie-st.png)

**receipt ç»“æ„**

![](åŒºå—é“¾æŠ€æœ¯ä¸åº”ç”¨.assets/receipt-st.png)

**åŒºå—å¤´ç»“æ„**

![](åŒºå—é“¾æŠ€æœ¯ä¸åº”ç”¨.assets/header-st.png)

**create-bloom**

![](åŒºå—é“¾æŠ€æœ¯ä¸åº”ç”¨.assets/bloom-create.png)

**query**

![](åŒºå—é“¾æŠ€æœ¯ä¸åº”ç”¨.assets/bloom-look-up.png)

## ETH-Ghoståè®®

å¦‚æœåˆ†å‰å¾ˆå¤šï¼Œå¤§å‹çŸ¿æ± (mining pool)ä¼šæœ‰  bias(ä¸­å¿ƒåŒ–ç®—åŠ›ä¼˜åŠ¿ mining centralization)

åˆå§‹Ghoståè®®ï¼šæ²¡æˆä¸ºæœ€é•¿åˆæ³•é“¾çš„åŒºå—è¢«ç§°ä¸ºuncle blockï¼Œå¦‚æœuncleä¹‹åè¢«åŒ…å«ä¹Ÿå¯ä»¥è·å¾—å¤§éƒ¨åˆ†çš„å‡ºå—å¥–åŠ±$\frac78\times 3$ ETHï¼Œå¯¹äºåŒ…å«uncle blockçš„èŠ‚ç‚¹èƒ½é¢å¤–è·å¾—$\frac1{32}\times 3$ ETHï¼Œä¸”æœ€å¤šåŒ…å«ä¸¤ä¸ªuncle block,æœ‰åˆ©äºç³»ç»Ÿå‡ºç°åˆ†å‰ååŠæ—¶è¿›è¡Œåˆå¹¶

![](åŒºå—é“¾æŠ€æœ¯ä¸åº”ç”¨.assets/uncle.png)

ä¸Šè¿°åè®®çš„é—®é¢˜ï¼š

- è¶…è¿‡ä¸¤ä¸ªuncle
- åœ¨æœ€é•¿åˆæ³•é“¾ä¸Šæ‹“å±•æ—¶æ²¡æœ‰çœ‹åˆ°æœ‰uncle
- è‡ªç§çš„è®°è´¦äººå¤„äºå•†ä¸šç«äº‰ï¼Œæ•…æ„ä¸åŒ…å«uncle

ä¿®æ”¹Ghostï¼šæœ€é•¿åˆæ³•é“¾(é˜²ç¯¡æ”¹ï¼Œè§£å†³ä¸´æ—¶æ€§åˆ†å‰)ä¸Šæ‰€æœ‰çš„åŒºå—éƒ½è®¤ä¹‹å‰çš„orphan blockä¸ºuncle

- ä¸ºé˜²æ­¢å…ˆäº§ç”Ÿå¾ˆå¤šuncleï¼Œä¹‹åä¸€ç›´åŒ…å«å‰é¢çš„uncleï¼Œå¦åŠ è§„å®šï¼šå½“ä»£uncleå¾—åˆ°7/8ï¼Œéš”ä»£uncleå¾—åˆ°6/8ï¼Œç›´åˆ°2/8ï¼Œå³uncle blockå’Œå½“å‰åŒºå—æœ‰7ä»£ä»¥å†…çš„å…±åŒç¥–å…ˆï¼Œåˆæ³•çš„uncleåªæœ‰6ä¸ªè¾ˆåˆ†ï¼Œæ­¤ä¸ºuncle rewardï¼›è€ŒåŒ…å«uncleçš„blockæ°¸è¿œæ˜¯1/32ï¼Œé¼“åŠ±å‡ºç°åˆ†å‰ä»¥åå°½æ—©è¿›è¡Œåˆå¹¶

ETHçš„å¥–åŠ±åˆ†ä¸ºblock reward(static)å’Œgas fee(dynamic)ï¼Œä½†æ˜¯uncle blockæ˜¯å¾—ä¸åˆ°åè€…

åŒ…å«uncle blockçš„æ—¶å€™ä¸ä¼šæ‰§è¡Œuncle blockçš„äº¤æ˜“ï¼Œåªä¼šæ£€æŸ¥uncle blockçš„åˆæ³•æ€§ï¼ˆæ˜¯å¦ç¬¦åˆæŒ–çŸ¿éš¾åº¦å³æ˜¯å¦å¾—åˆ°äº†è®°è´¦æƒï¼‰

- äº¤æ˜“å¯èƒ½ä¼šä¸ä¸»é“¾ä¸Šçš„å†²çªï¼Œæˆ–è€…å˜ ä¸ºéæ³•äº¤æ˜“ï¼Œå› è€Œä¸ä¼šæ£€æŸ¥äº¤æ˜“çš„åˆæ³•æ€§

å¦‚æœåˆ†å‰é“¾ä¹‹åè¿˜è·Ÿç€ä¸€ä¸²ï¼Œä¸ä¼šå¯¹åé¢è·Ÿç€çš„åŒºå—æä¾›å¥–åŠ±ï¼Œåªæœ‰ç¬¬ä¸€ä¸ªuncleå¯ä»¥å¾—åˆ°å¥–åŠ±ï¼Œå¦‚æœç»™åé¢çš„unclesæä¾›çš„è¯ï¼Œforking attackçš„æˆæœ¬å°±å¾ˆä½ï¼Œå› ä¸ºä¸æˆåŠŸçš„forking attackè¿˜èƒ½å¾—åˆ°å¥–åŠ±

## ETH-æŒ–çŸ¿ç®—æ³•

blockchain is secured by mining

bug bounty

ç›®æ ‡æ˜¯ASIC resistanceï¼Œæ‰€ä»¥è®¾è®¡äº†memory hard mining puzzle 

LiteCoinè±ç‰¹å¸ä½¿ç”¨çš„mining puzzleä¸ºscrpytï¼Œä½†æ˜¯verifyéœ€è¦çš„å†…å­˜åŒºåŸŸå’Œsolveçš„åŒºåŸŸå¤§å°ç›¸åŒï¼Œä¸ºäº†èƒ½åœ¨å„ç§å°å‹æœºå™¨ä¸ŠæŒ–çŸ¿ï¼Œæ•…è®¾ç½®å†…å­˜å¤§å°ä»…ä¸º128Kï¼Œç”±æ­¤å¯¼è‡´æ²¡æœ‰ASIC resistance

- å¼Šç«¯éªŒè¯å’Œæ±‚è§£éƒ½å›°éš¾ (**difficult  to solve but easy to verify**)
- å› æ­¤å®é™…ä½¿ç”¨æ—¶åªæœ‰128k

ETHæœ‰ä¸¤ä¸ªæ•°æ®é›†16M cacheå’Œ1G dataset DAGï¼Œè¿™ä¸¤ä¸ªæ•°æ®é›†éšæ—¶é—´å¢é•¿è€Œå¢å¤§ã€‚

æŒ–çŸ¿ç®—æ³•ethashï¼š

æœ‰ä¸€ä¸ªæ•°ç»„ï¼Œå¯¹seedå–hashæ”¾åœ¨ç¬¬ä¸€ä¸ªï¼Œç„¶åå¯¹ç¬¬ä¸€ä¸ªå–hashæ”¾åœ¨ç¬¬äºŒä¸ªï¼Œç”±æ­¤å¡«æ»¡æ•´ä¸ªcacheæ•°ç»„ã€‚

ç„¶åé€šè¿‡cacheä¸­çš„ç¬¬`i % cache_size`ä¸ªå…ƒç´ ç”Ÿæˆåˆå§‹mixï¼Œç„¶åå¾ªç¯256æ¬¡ï¼Œæ¯æ¬¡ç”¨`get_int_from_item`æ¥å¾—åˆ°ä¸‹ä¸€ä¸ªè¦è®¿é—®çš„cacheå…ƒç´ çš„ä¸‹æ ‡ï¼Œç”¨è¿™ä¸ªcacheå…ƒç´ å’Œmixå¾—åˆ°æ–°çš„mixï¼Œæœ€åå¯¹mixå–hashæ”¾åœ¨datasetçš„ç¬¬iä¸ªä½ç½®

```python
# æ¯éš”30000ä¸ªå—ä¼šé‡æ–°ç”Ÿæˆseedï¼ˆå¯¹åŸæ¥çš„seedå–hashï¼‰
# cacheåˆå§‹å¤§å°ä¸º16M,æ¯éš”30000ä¸ªåŒºå—é‡æ–°ç”Ÿæˆæ—¶å¢å¤§åˆå§‹å¤§å°çš„1/128å³128K
def mkcache(cache_size, seed):
    #ç¬¬ä¸€ä¸ªå…ƒç´ ä¸ºç§å­çš„hash
    o = [hash(seed)]
    for i in range(1, cache_size):
        #åé¢çš„æ¯ä¸ªå…ƒç´ æ˜¯å‰ä¸€ä¸ªå…ƒç´ çš„hash
        o.append(hash(o[-1]))
    return o

# ä»cacheç”Ÿæˆ1Gçš„å¤§æ•°æ®é›†
# æ±‚datasetç¬¬iä¸ªå…ƒç´ 
def calc_dataset_item(cache, i):
    cache_size = cache.size
    mix = hash(cache[i % cache_size] ^ i)
    for j in range(256):
        #æ±‚å‡ºä¸‹ä¸€ä¸ªè¦è¯»å–çš„ä½ç½®
        cache_index = get_int_from_item(mix)
        # é€šè¿‡indexä½ç½®çš„æ•°å’Œå½“å‰çš„hashè®¡ç®—å‡ºä¸‹ä¸€ä¸ªhashå€¼
        mix = make_item(mix, cache[cache_index % cache_size])
        #ä¾æ¬¡è¿­ä»£256è½®ï¼Œè·å–64å­—èŠ‚çš„hash,ä½œä¸ºå¤§æ•°æ®é›†ä¸­çš„ç¬¬iä¸ªå…ƒç´ 
    return hash(mix)

# æ±‚æ•´ä¸ªdataset
def calc_dataset(full_size, cache):
    return [calc_dataset_item(cache, i) for i in range(full_size)]

# datasetåˆå§‹å¤§å°ä¸º1G,æ¯éš”30000ä¸ªåŒºå—é‡æ–°ç”Ÿæˆæ—¶å¢å¤§åˆå§‹å¤§å°çš„1/128å³8M
# çŸ¿å·¥æŒ–çŸ¿header(æ–¹ä¾¿è½»èŠ‚ç‚¹éªŒè¯ï¼Œnonceï¼Œå¤§æ•°æ®é›†çš„ä¸ªæ•°ï¼Œç”Ÿæˆçš„å¤§æ•°æ®é›†)
def hashimoto_full(header, nonce, full_size, dataset):
    mix = hash(header, nonce)
    for i in range(64):
        dataset_index = get_int_from_item(mix) % full_size
        mix = make_item(mix, dataset[dataset_index])
        mix = make_item(mix, dataset[dataset_index + 1])
    #ç”¨äºä¸æŒ–çŸ¿éš¾åº¦çš„ç›®æ ‡é˜ˆå€¼æ¯”è¾ƒ
    return hash(mix)
# è½»èŠ‚ç‚¹éªŒè¯
def hashimoto_light(header, nonce, full_size, cache):
    mix = hash(header, nonce)
    for i in range(64):
        dataset_index = get_int_from_item(mix) % full_size
        
        mix = make_item(mix, calc_dataset_item(cache, dataset_index))
        mix = make_item(mix, calc_dataset_item(cache, dataset_index + 1))
    return hash(mix)

# mine function
def mine(full_size, dataset, header, target):
    nonce = random.randint(0, 2**64)
    while hashimoto_full(header, nonce, full_size, dataset) > target:
        nonce = (nonce + 1) % 2**64
    return nonce
```

ç›®å‰ä¸»è¦æ˜¯  GPUæŒ–çŸ¿

ç›®å‰ä»ç„¶æ˜¯PoWï¼ˆProof of Workï¼‰ï¼Œä¸€ç›´æƒ³è½¬å‘PoSï¼ˆProof of Stakeæƒç›Šè¯æ˜ï¼‰ï¼Œè¿™æ˜¯ä¸æŒ–çŸ¿çš„

ETHä½¿ç”¨pre-miningï¼Œé¢„ç•™äº†ä¸€äº›ETHï¼ˆå®é™…ä¸Šæ˜¯ç»å¤§éƒ¨åˆ†ï¼‰ç»™åˆ›å§‹äººï¼Œpre-saleç›¸å½“äºä¼—ç­¹ï¼Œä¹°ä¸€äº›åˆå§‹å¸ä½œä¸ºåç»­å¼€å‘çš„èµ„é‡‘

- <->æŒ–çŸ¿çš„ç®—æ³•è®¾è®¡è¦å°½å¯èƒ½çš„è®©é€šç”¨è®¡ç®—è®¾å¤‡ä¹Ÿèƒ½å¤Ÿå‚åŠ ï¼Œå‚åŠ çš„äººè¶Šå¤šï¼ŒæŒ–çŸ¿çš„è¶Šæ°‘ä¸»ï¼ŒåŒºå—é“¾å°±è¶Šå®‰å…¨
- <-> ASICèŠ¯ç‰‡  æŒ–çŸ¿æˆæœ¬é«˜ï¼Œæ—©æœŸéœ€è¦æŠ•å…¥å¤§é‡èµ„æºï¼Œæ”»å‡»æˆæœ¬é«˜
- è¿™ç©æ„çœŸå°±æœ‰å¥½æœ‰åå§

## ETH-æŒ–çŸ¿éš¾åº¦çš„è°ƒæ•´

BTCæ˜¯æ¯éš”2016ä¸ªåŒºå—è°ƒæ•´ä¸€æ¬¡ï¼Œç»´æŒå‡ºå—æ—¶é—´å¹³å‡åœ¨10åˆ†é’Ÿå·¦å³ã€‚ETHæ˜¯æ¯ä¸ªåŒºå—éƒ½æœ‰å¯èƒ½è°ƒæ•´éš¾åº¦ï¼Œä¸”è°ƒæ•´ç®—æ³•æ¯”è¾ƒå¤æ‚ä¸”æœ‰å¤šä¸ªç‰ˆæœ¬
$$
D(H)=\left\{
\begin{array}{lcl}
D_0 & & \rm{if~ H_1=0} \\
max(D_0,P(H)_{H_d}+x\times\zeta_2)+\epsilon & & \rm{otherwise}
\end{array}
\right.\\
{\rm where}~D_0=131072\\
x=\lfloor\frac{P(H)_{H_d}}{2048}\rfloor\\
\zeta_2=max(y-\lfloor\frac{H_s-P(H)_{H_s}}{9}\rfloor,-99)\\
\epsilon=\lfloor2^{\lfloor H_i'\div100000\rfloor-2}\rfloor\\
H_i'=max(H_i-3000000,0)
$$
å…¶ä¸­$P(H)_{H_d}+x\times\zeta_2)+\epsilon$æ˜¯åŸºç¡€éš¾åº¦ï¼Œ$\epsilon$æ˜¯éš¾åº¦ç‚¸å¼¹ä¸ºäº†å‘æƒç›Šè¯æ˜è¿‡æ¸¡

$P(H)_{H_d}$æ˜¯çˆ¶åŒºå—çš„éš¾åº¦

 $y$å’Œçˆ¶åŒºå—çš„uncleæ•°æœ‰å…³ï¼Œå¦‚æœçˆ¶åŒºå—ä¸­åŒ…å«uncleï¼Œåˆ™$y=2$ï¼Œå¦åˆ™$y=1$ï¼Œå› ä¸ºåŒ…å«uncleçš„æ—¶å€™æ–°å‘è¡Œçš„è´§å¸é‡å¤§ï¼Œéœ€è¦é€‚å½“æé«˜éš¾åº¦

$H_s$æ˜¯æœ¬åŒºå—çš„æ—¶é—´æˆ³ï¼Œ$P(H)_{H_s}$æ˜¯çˆ¶åŒºå—çš„æ—¶é—´æˆ³ï¼Œå‡ä»¥ç§’ä¸ºå•ä½ï¼Œå¹¶è§„å®š$H_s>P(H)_{H_s}$ï¼Œå‡ºå—æ—¶é—´è¿‡çŸ­å°±æé«˜éš¾åº¦ï¼Œå¦åˆ™ä¸‹é™

æ‰€ä»¥å¦‚æœçˆ¶åŒºå—ä¸åŒ…å«uncleï¼ˆ$y=1$ï¼‰ï¼Œåˆ™å½“å‡ºå—æ—¶é—´å°äºç­‰äº8çš„æ—¶å€™å°±è¦æé«˜éš¾åº¦ï¼Œå¤§äº17çš„æ—¶å€™é™ä½éš¾åº¦

è®¾ç½®éš¾åº¦ç‚¸å¼¹çš„åŸå› ï¼šå½“åè®®è¿åˆ°PoSæ—¶æé«˜çŸ¿å·¥è¿ç§»çš„æ„æ„¿

$\epsilon$æ˜¯2çš„æŒ‡æ•°ï¼Œæ¯10ä¸‡ä¸ªå—æ‰©å¤§ä¸€å€ï¼Œå¢é•¿é€Ÿåº¦å¿«ï¼Œä»¥æ­¤æé«˜æŒ–çŸ¿éš¾åº¦ä½¿å¾—çŸ¿å·¥ä¸å¾—ä¸æ”¾å¼ƒæŒ–çŸ¿ï¼Œè½¬å‘PoSï¼Œä½†æ˜¯ç›®å‰PoSè¿˜æ²¡æœ‰æˆåŠŸå®ç°ï¼Œå¯¼è‡´éš¾åº¦è¿‡é«˜ï¼Œäºæ˜¯ä¿®æ”¹äº†åŸæ¥çš„åè®®ï¼Œå°†å‡ºå—å·å‡å°‘300Wä¸ªï¼Œå¹¶æŠŠå‡ºå—å¥–åŠ±ä»5ä¸ªé™ä¸º2ä¸ª

## ETH-æƒç›Šè¯æ˜

**proof of state**

virtual mining å¸çš„æ•°é‡å°±æ˜¯æŠ•ç¥¨æƒ(åæ­£å°±æ˜¯é’±å‘—)

ä¼˜ç‚¹ï¼š

- ç¯ä¿
- PoWæ²¡æœ‰å®ç°é—­ç¯ï¼Œå‘åŠ¨æ”»å‡»çš„èµ„æºå¯ä»¥ä»ç³»ç»Ÿå¤–éƒ¨è·å–(æ¯”å¦‚èŠ±é’±è´­ä¹°çŸ¿æœºæå‡ç®—åŠ›)ï¼Œå°å¸ç§å¾ˆå®¹æ˜“å—åˆ°å¤–ç•Œå¤§èµ„æœ¬çš„æ”»å‡»AltCoin Infanticide(æ‰¼æ€åœ¨æ‘‡ç¯®ä¸­)ï¼›è€ŒPoSä¸­ï¼Œå‘é€æ”»å‡»çš„èµ„æºå¿…é¡»ä»ç³»ç»Ÿå†…éƒ¨è·å–ï¼Œå®ç°äº†é—­ç¯ï¼Œå¦‚æœå¤–ç•Œèµ„æºå¤§é‡ä¹°å…¥è¯¥å¸ç§ï¼Œå°±ä¼šå¯¼è‡´å‡å€¼ï¼Œåè€Œä½¿å¾—å…¶ä¸æ˜“è¢«æ”»å‡»

æœ‰çš„å¸é‡‡ç”¨PoWå’ŒPoSçš„æ··åˆï¼Œå³æŒ–çŸ¿éš¾åº¦å’Œä½ æŒæœ‰çš„å¸çš„æ•°é‡ç›¸å…³ï¼Œä½†æ˜¯è¿™æ ·ä¼šæœ‰é©¬å¤ªæ•ˆåº”(å¯Œè€…è¶Šå¯Œï¼Œç©·è€…è¶Šç©·)ï¼Œæ‰€ä»¥ä¼šæœ‰Proof of Depositï¼Œä½ æŠ•å…¥ä¸€äº›å¸æ¥é™ä½æŒ–çŸ¿éš¾åº¦ï¼Œç„¶åè¿™äº›æŠ•å…¥çš„å¸åœ¨ä¸€å®šæ—¶é—´å†…ä¸èƒ½å†ç”¨

æŒ‘æˆ˜ï¼š  

- æŒ–çŸ¿ä¸èƒ½ä¸¤è¾¹éƒ½æŒ–ï¼Œä½†ä¸‹æ³¨å¯ä»¥ä¸¤è¾¹éƒ½ä¸‹
- å‡ºç°ä¸¤è¾¹ä¸‹æ³¨æƒ…å†µnothing at stakeï¼Œå³å¤šåˆ†å‰æ—¶ï¼Œä½ åœ¨ä¸åŒçš„åˆ†å‰ä¸­æŠ•å…¥å¸æ¥å†³å®šå“ªä¸ªåˆ†å‰æ˜¯æœ€é•¿åˆæ³•é“¾ï¼Œè¿™äº›é’±æ˜¯ä¸ä¼šè¢«é”å®šçš„ï¼Œå°±å¯ä»¥ä¸¤è¾¹ä¸‹æ³¨

ETHå‡†å¤‡ä½¿ç”¨çš„æƒç›Šè¯æ˜æ–¹æ³•å«Casper the Friendly Finality Gadget (FFG)

å¼•å…¥ValidatoréªŒè¯è€…ï¼ŒæŠ•å…¥ä¸€å®šETHä½œä¸ºä¿è¯é‡‘è¢«é”å®šï¼ŒèŒè´£æ˜¯æ¨åŠ¨è¾¾æˆå“ªæ¡æ˜¯æœ€é•¿åˆæ³•é“¾çš„å…±è¯†ï¼ŒæŠ•ç¥¨çš„æƒé‡å–å†³äºä¿è¯é‡‘çš„æ•°ç›®å¤§å°ã€‚æ¯æŒ–é™¤100ä¸ªåŒºå—å°±ä½œä¸ºä¸€ä¸ªepochï¼Œè€Œepochæˆä¸ºä¸€ä¸ªfinalityéœ€è¦æŠ•ç¥¨ï¼Œç¬¬ä¸€è½®æŠ•ç¥¨æ˜¯prepare messageï¼Œç¬¬äºŒè½®æŠ•ç¥¨æ˜¯commit messageï¼Œæ¯ä¸€è½®æŠ•ç¥¨éƒ½éœ€è¦æœ‰2/3çš„é€šè¿‡ã€‚å®é™…å®ç°æ—¶ï¼šä¸åŒºåˆ†ä¸¤ä¸ªmessageï¼ŒåŒæ—¶é™ä½epochä¸º50ä¸ªåŒºå—ï¼Œè¦è¿ç»­ä¸¤ä¸ªepochéƒ½å¾—åˆ°2/3çš„åŒæ„æ‰é€šè¿‡ã€‚éªŒè¯è€…éªŒè¯é€šè¿‡ä¹Ÿå¯ä»¥å¾—åˆ°å¥–åŠ±ï¼Œæœ‰ä¸è‰¯è¡Œä¸ºå°±æ‰£é™¤éƒ¨åˆ†ä¿è¯é‡‘ï¼Œä¸¤è¾¹ä¸‹æ³¨å…¨éƒ¨é”€æ¯ï¼ŒéªŒè¯è€…æœ‰ä»»æœŸå’Œç­‰å¾…æœŸï¼Œå½“ç­‰å¾…æœŸæ— äººä¸¾æŠ¥ä¹‹åå¯ä»¥å¾—åˆ°ä¿è¯é‡‘å’Œå¥–åŠ±

## ETH-æ™ºèƒ½åˆçº¦

æ™ºèƒ½åˆçº¦æ˜¯è¿è¡Œåœ¨åŒºå—é“¾ä¸Šçš„ä¸€æ®µä»£ç ï¼Œä»£ç é€»è¾‘å®šä¹‰äº†åˆçº¦çš„å†…å®¹

æ™ºèƒ½åˆçº¦è´¦æˆ·ä¿å­˜äº†å½“å‰åˆçº¦çš„çŠ¶æ€

- balance å½“å‰è´¦æˆ·ä½™é¢
- nonce äº¤æ˜“æ¬¡æ•°
- code åˆçº¦ä»£ç 
- storage å­˜å‚¨ï¼Œæ•°æ®ç»“æ„æ˜¯ä¸€é¢—MPT

æ•°ç»„ï¼špush / length 				bidders.push(bidder) 			bidder.length

map hash tableé»˜è®¤ä¸º0ï¼Œä¸æ”¯æŒéå†ï¼Œéœ€è¦å¦å¤–å­˜å‚¨

### è°ƒç”¨æ™ºèƒ½åˆçº¦

- å¤–éƒ¨è´¦æˆ·è°ƒç”¨æ™ºèƒ½åˆçº¦

    - åˆ›å»ºä¸€ä¸ªäº¤æ˜“ï¼Œæ¥æ”¶åœ°å€ä¸ºè¦è°ƒç”¨çš„é‚£ä¸ªåˆçº¦åœ°å€ï¼ŒdataåŸŸå¡«å†™è¦è°ƒç”¨çš„å‡½æ•°åŠå…¶å‚æ•°çš„ç¼–ç å€¼

- åˆçº¦ä¹‹é—´è°ƒç”¨(ä¸€ä¸ªäº¤æ˜“åªæœ‰EOAå¯ä»¥å‘èµ·ï¼Œåˆçº¦ä¸èƒ½ä¸»åŠ¨è°ƒç”¨)

    -  ç›´æ¥è°ƒç”¨(è°ƒç”¨åˆçº¦æ‰§è¡Œé”™è¯¯ï¼Œä¼šå¯¼è‡´å‘èµ·è°ƒç”¨çš„åˆçº¦ï¼Œå›æ»š)

        ~~~solidity
        contract A {
        	event LogCallFoo(string str);
        	function foo(string str) returns (uint){
        		emit LogCallFoo(str);
        		return 123;
        	}
        }
        
        contract B {
        	uint ua;
        	function callAFooDirectly(address addr) public {
        		A a = new A(addr);
        		ua = a.foo("call foo directly");
        	}
        }
        
        ~~~

    -  ä½¿ç”¨address ç±»å‹çš„callå‡½æ•°

        ~~~solidity
        contract C {
        	function callAFooByCall(address addr)public returns (bool) {
        //1.ç¬¬ä¸€ä¸ªå‚æ•°è¢«ç¼–æˆ4ä¸ªå­—èŠ‚ï¼Œè¡¨ç¤ºè¦è°ƒç”¨çš„å‡½æ•°ç­¾å(funcName(paramType))
        	//2.å…¶ä»–å‚æ•°ä¼šè¢«æ‰©å±•åˆ°32ä¸ªå­—èŠ‚ï¼Œè¡¨ç¤ºè¦è°ƒç”¨çš„å‡½æ•°çš„å‚æ•°
        	//3.callè¿”å›trueï¼Œè¡¨ç¤ºå‡½æ•°æ‰§è¡Œå®Œæ¯•ï¼Œè¿”å›falseè¡¨ç¤ºå¼•å‘EVMå¼‚å¸¸ï¼Œæ— æ³•è·å–å‡½æ•°è¿”å›å€¼ï¼Œå‘èµ·è°ƒç”¨çš„å‡½æ•°å¹¶ä¸ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œè€Œæ˜¯ç»§ç»­æ‰§è¡Œ
        		bytes4 funcsig = bytes4(keccak256("foo(string)"));
        		if (addr.call(funcsig,"call foo by func call"))
        			return true;
                return false
        	}
        }
        å¯ä»¥é€šè¿‡.gas() .value()è°ƒæ•´æä¾›çš„gasæ•°é‡æˆ–è€…æä¾›ä¸€äº›ETH
        ~~~

    -  delegatecall()

        -  ä½¿ç”¨ä¸callç›¸åŒï¼Œåªæ˜¯ä¸èƒ½ä½¿ç”¨.value()
        -  ä¸éœ€è¦åˆ‡æ¢åˆ°è¢«è°ƒç”¨çš„åˆçº¦çš„ç¯å¢ƒä¸­æ‰§è¡Œï¼Œè€Œæ˜¯åœ¨å½“å‰åˆçº¦çš„ç¯å¢ƒä¸­æ‰§è¡Œï¼Œå³context
            -  callåˆ‡æ¢åˆ°è¢«è°ƒç”¨çš„æ™ºèƒ½åˆçº¦çš„ä¸Šä¸‹æ–‡
            -  delegateCall()åªæ˜¯ç”¨ç»™å®šåœ°å€çš„ä»£ç ï¼Œå…¶ä½™å±æ€§(å­˜å‚¨ï¼Œä½™é¢ç­‰)éƒ½å–è‡ªå½“å‰åˆçº¦ï¼ŒdelegateCallç›®çš„æ˜¯ä½¿ç”¨å­˜å‚¨åœ¨å¦å¤–åˆçº¦ä¸­çš„åº“ä»£ç 

- payable æ¥å—å¤–éƒ¨è½¬è´¦

- fallback()

    - ```solidity
        function() public [payable] {
        	...
        }
        //åŒ¿åå‡½æ•°ï¼Œæ— å‚æ— è¿”å›å€¼
        è°ƒç”¨æƒ…å†µï¼š
        	- ç›´æ¥å‘ä¸€ä¸ªåˆçº¦åœ°å€è½¬è´¦è€Œä¸åŠ ä»»ä½•data
        	- è¢«è°ƒç”¨çš„å‡½æ•°ä¸å­˜åœ¨
        è‹¥è½¬è´¦é‡‘é¢ä¸ä¸ºé›¶ï¼ŒåŒæ ·éœ€è¦å£°æ˜payable,å¦åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸
        è½¬è´¦é‡‘é¢å¯ä»¥ä¸º0ï¼Œä½†æ˜¯gasè´¹æ˜¯è¦ç»™çš„
        ```

### solidityæ ·ä¾‹

#### V1

```solidity
// å£°æ˜ä½¿ç”¨çš„solidityç‰ˆæœ¬
//SPDX-License-Identifier:MIT
pragma solidity ^0.4.21

é¢å‘å¯¹è±¡çš„ç¼–ç¨‹è¯­è¨€ï¼Œå¼ºç±»å‹è¯­è¨€

contract SimpleAuction {
	// çŠ¶æ€å˜é‡
	address public beneficiary; // æ‹å–å—ç›Šäºº
	uint public auctionEnd; // æ‹å–ç»“æŸæ—¶é—´
	address public highestBidder; // å½“å‰æœ€é«˜å‡ºä»·äºº
	mapping(address => uint) bids; // æ‰€æœ‰ç«æ‹è€…çš„å‡ºä»·
	address[] bidders; // æ‰€æœ‰ç«æ‹è€…
	bool ended; // æ˜¯å¦ç»“æŸç«æ‹
	 
	// logè®°å½•
	// éœ€è¦è®°å½•çš„äº‹ä»¶
	//æ‹å–çš„æœ€é«˜å”®ä»·å¢åŠ 
	event HighestBidIncreased(address bidder, uint amount);
	event AuctionEnded(address winner,int amount);
    
	// æ„é€ å‡½æ•°ï¼Œä»…åœ¨åˆçº¦åˆ›å»ºæ—¶è°ƒç”¨ä¸€æ¬¡
	// ä»¥å—ç›Šè€…åœ°å€`_beneficiary`çš„åä¹‰ï¼Œ
	// åˆ›å»ºä¸€ä¸ªç®€å•çš„æ‹å–ï¼Œæ‹å–æ—¶é—´ä¸º`_biddingTime`ç§’
	constructor(uint _biddingTime, address _beneficiary) public {
		beneficiary = _beneficiary;
		auctionEnd = now + _biddingTime;
	}
	
	// æˆå‘˜å‡½æ•°ï¼Œå¯ä»¥è¢«ä¸€ä¸ªå¤–éƒ¨è´¦æˆ·æˆ–è€…åˆçº¦è´¦æˆ·è°ƒç”¨
	// å¯¹æ‹å–è¿›è¡Œå‡ºä»·ï¼Œéšäº¤æ˜“ä¸€èµ·å‘é€çš„etherä¸ä¹‹å‰å·²ç»å‘é€çš„etherçš„å’Œä¸ºæœ¬æ¬¡å‡ºä»·
	function bid() public payable {
		// æ‹å–å°šæœªç»“æŸ
		require(now <= auctionEnd);
		
		// å¦‚æœå‡ºä»·ä¸å¤Ÿé«˜ï¼Œæœ¬æ¬¡å‡ºä»·æ— æ•ˆï¼Œç›´æ¥æŠ¥é”™è¿”å›
		//msg.value å‘èµ·è°ƒç”¨æ—¶è½¬è´¦çš„ethæ•°ç›®
		//ä¸Šæ¬¡çš„å‡ºä»·+å½“å‰è°ƒç”¨çš„eth
		//æŸ¥è¯¢é”®å€¼ä¸å­˜åœ¨ï¼Œè¿”å›é»˜è®¤å€¼ä¸º0
		require(bids[msg.sender] + msg.value > bids[highestBidder]);
		
		// å¦‚æœæ­¤äººä¹‹å‰æœªå‡ºä»·ï¼Œåˆ™åŠ å…¥åˆ°ç«æ‹è€…åˆ—è¡¨ä¸­
		if (!bids[msg.sender] == uint(0)) {
			bidders.push(msg.sender);
		}
		
		// æœ¬æ¬¡å‡ºä»·æ¯”å½“å‰æœ€é«˜è€…é«˜ï¼Œå–ä»£ä¹‹
		highestBidder = msg.sender;
		bids[msg.sender] += msg.value;
		emit HighestBidIncreased(msg.sender, bids[msg.sender]);
	}
	
	// ç»“æŸæ‹å–ï¼ŒæŠŠæœ€é«˜çš„å‡ºä»·å‘é€ç»™å—ç›Šäºº
	// å¹¶æŠŠæœªä¸­æ ‡çš„å‡ºä»·è€…çš„é’±è¿”è¿˜
	function auctionEnd() public {
		// æ‹å–å·²æˆªæ­¢
		require(now > auctionEnd);
		// å‡½æ•°æœªè¢«è°ƒç”¨è¿‡
		require(!ended);
		
		// æŠŠæœ€é«˜çš„å‡ºä»·å‘é€ç»™å—ç›Šäºº
		beneficiary.transfer(bids[highestBidder]);
		for (uint i = 0; i < bidders.length; i++) {
			address bidder = bidders[i];
			if (bidder == highestBidder) continue;
			bidder.transfer(bids[bidder]);
			// æ³¨æ„!!! 
			// å¦‚æœHackeræœ‰ä¸ªåˆçº¦è´¦æˆ·è°ƒç”¨bidè€Œå®ƒæ²¡æœ‰fallbackå‡½æ•°ï¼Œé‚£ä¹ˆå½“é€€æ¬¾çš„æ—¶å€™transferå‘ç”Ÿé—®é¢˜ï¼Œå°±ä¼šå…¨éƒ¨å›æ»šï¼Œå¯¼è‡´æ‰€æœ‰äººéƒ½æ²¡æœ‰æ”¶åˆ°é’±(solidityåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­æ”¹çš„æœ¬åœ°çš„çŠ¶æ€ï¼Œåªæœ‰æœ€åå‘å¸ƒåœ¨Block Chainä¹‹åæ‰€æœ‰èŠ‚ç‚¹éƒ½ç…§ç€åšä¸€é)
		}
		ended = true;
        emit AuctionEnded(highestBidder, bids[highestBidder]);
	}
}

contract Hacker {
	function hack_bid(address addr){
		SimpleAuction sa = SimpleAuction(addr);
		sa.bid.value(msg.value())();
	}
}
```

#### V2

- ä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œæå‡ºï¼šè®©æŠ•æ ‡è€…è‡ªå·±å–å›æ ‡ä»·ï¼Œå°†ä¸Šè¿°`auctionEnd`å‡½æ•°ä¿®æ”¹æˆä¸¤ä¸ªå°å‡½æ•°

```solidity
// ä½¿ç”¨withdrawæ¨¡å¼
// ç”±æŠ•æ ‡è€…è‡ªå·±å–å›å‡ºä»·ï¼Œè¿”å›æ˜¯å¦æˆåŠŸ
function withdraw() public returns (bool) {
	// æ‹å–å·²æˆªæ­¢
	require(now > auctionEnd);
	// ç«æ‹æˆåŠŸè€…éœ€è¦æŠŠé’±ç»™å—ç›Šäººï¼Œä¸å¯å–å›å‡ºä»·
	require(msg.sender != highestBidder);
	// å½“å‰åœ°å€æœ‰é’±å¯å–
	require(bids[msg.sender] > 0);
	
	uint amount = bids[msg.sender];
	if (msg.sender.call.value(amount)()) {
		bids[msg.sender] = 0;
		return true;
	}
	return false;
}

event Pay2Beneficiary(address winner, uint amount);
// ç»“æŸæ‹å–ï¼ŒæŠŠæœ€é«˜çš„å‡ºä»·å‘é€ç»™å—ç›Šäºº
function pay2Beneficiary() public returns (bool) {
	// æ‹å–å·²æˆªæ­¢
	require(now > auctionEnd);
	// å½“å‰åœ°å€æœ‰é’±å¯å–
	require(bids[highestBidder] > 0);
	
	uint amount = bids[highestBidder];
	bids[highestBidder] = 0; // æ³¨æ„è¿™é‡Œå…ˆç½®ä¸º0ç„¶åå†withdraw
	emit Pay2Beneficiary(highestBidder, bids[highestBidder]);
	
	if (!beneficiary.call.value(amount)()) {
		bids[highestBidder] = amount;
		return false;
	}
	return true;
}
```

ä½†æ˜¯è¿˜å¯ä»¥å‘åŠ¨é‡å…¥æ”»å‡» (Re-entrancy Attack)ï¼š

```solidity
contract HackV2 {
	uint stack = 0;
	function hack_id(address addr) payable public{
		SimpleAuction sa = SimpleAuction(addr);
		sa.bid.value(msg.value)();
	}
	
	function hack_withdraw(address addr) public payable{
		SimpleAuction(addr).whthdirw();
	}
	
	function() public payable {
        stack += 2;
        if (msg.sender.balance >= msg.value && msg.gas > 6000 && stack < 500) {
            SimpleAuctionV2(msg.sender).withdraw();
        }
	}
}
```

å½“contractçš„`withdraw`æ‰§è¡Œåˆ°`msg.sender.call.value(amount)()`æ—¶ï¼Œå°±ä¼šè§¦å‘ä¸Šé¢çš„fallbackå‡½æ•°ï¼Œæ­¤æ—¶åˆä¼šè°ƒç”¨`withdraw`ï¼Œé™·å…¥é€’å½’ã€‚

ä½†æ˜¯ä¸Šé¢çš„å†™æ³•æ²¡æœ‰é—®é¢˜ï¼Œå› ä¸ºå·²ç»å…ˆæŠŠå¯¹åº”è´¦æˆ·ä½™é¢è®¾ç½®æˆ0äº†

æœ€å¥½å°†callæ”¹æˆsendæˆ–è€…transferï¼Œå› ä¸ºgas feeæ¯”è¾ƒå°‘

---

### æ™ºèƒ½åˆçº¦çš„åˆ›å»ºå’Œè¿è¡Œ

- æ™ºèƒ½åˆçº¦çš„ä»£ç å†™å®Œåï¼Œè¦ç¼–è¯‘æˆbytecode

- åˆ›å»ºåˆçº¦ï¼šå¤–éƒ¨å¸æˆ·å‘èµ·ä¸€ä¸ªè½¬è´¦äº¤æ˜“åˆ°0x0çš„åœ°å€

    - è½¬è´¦çš„é‡‘é¢æ˜¯0ï¼Œä½†æ˜¯è¦æ”¯ä»˜æ±½æ²¹è´¹

    - åˆçº¦çš„ä»£ç æ”¾åœ¨dataåŸŸé‡Œ

    - çŸ¿å·¥æ‰“åŒ…ï¼Œè¿”å›åˆçº¦åœ°å€

- æ™ºèƒ½åˆçº¦è¿è¡Œåœ¨EVM (Ethereum Virtual Machine)ä¸Š
    - 256ä½å¯»å€ 
    - é€šè¿‡åŠ ä¸€å±‚è™šæ‹Ÿæœºï¼Œå¯¹æ™ºèƒ½åˆçº¦çš„è¿è¡Œæä¾›ä¸€è‡´æ€§å¹³å°  world wide computer
- ä»¥å¤ªåŠæ˜¯ä¸€ä¸ªäº¤æ˜“é©±åŠ¨çš„çŠ¶æ€æœº
    - è°ƒç”¨æ™ºèƒ½åˆçº¦çš„äº¤æ˜“å‘å¸ƒåˆ°åŒºå—é“¾ä¸Šåï¼Œæ¯ä¸ªçŸ¿å·¥éƒ½ä¼šæ‰§è¡Œè¿™ä¸ªäº¤æ˜“ï¼Œä»å½“å‰çŠ¶æ€ç¡®å®šæ€§åœ°è½¬ç§»åˆ°ä¸‹ä¸€ä¸ªçŠ¶æ€
- æŒ–çŸ¿å’Œæ™ºèƒ½åˆçº¦çš„æ‰§è¡Œå…ˆåé¡ºåºï¼Ÿ
    - æ³¨æ„Block Headerä¸­æœ‰ä¸‰æ£µæ ‘çš„æ ¹hashå€¼ï¼Œè€Œè¯•nonceçš„æ—¶å€™éœ€è¦å›ºå®šBlock Header
    - æ‰€ä»¥å¿…é¡»å…ˆæ‰§è¡Œå¾—åˆ°Block Header
    - å¦‚æœæˆ‘åœ¨æœ¬æ¬¡æ¶ˆè€—èµ„æºæ‰§è¡Œæ™ºèƒ½åˆçº¦ä½†æ˜¯æœ€åæ²¡æœ‰è®°è´¦æƒï¼Œæˆ‘èƒ½å¾—åˆ°å•¥ï¼Ÿ
        - Gas Feeæ˜¯æ²¡æœ‰çš„ï¼Œåªç»™æœ€åå¾—åˆ°è®°è´¦æƒçš„äºº
        - uncle rewardä¹Ÿæ˜¯æ²¡æœ‰å¿…è¦çš„ï¼Œå› ä¸ºæ— è®°å¿†æ€§ï¼Œæ¯”å¦‚ç›´æ¥åˆ‡æ¢åˆ°æœ€é•¿åˆæ³•é“¾ä¸ŠæŒ–
        - å®é™…ä¸Šæ²¡æœ‰è¡¥å¿ï¼Œè€Œä¸”å¾—è‡ªå·±æœ¬åœ°éƒ½éªŒè¯ä¸€éï¼Œå‡å¦‚æˆ‘ä¸éªŒè¯ï¼ˆåæœæ˜¯å½±å“å®‰å…¨æ€§ï¼‰ï¼Œä¸‰æ£µæ ‘çš„å†…å®¹æ²¡æœ‰æ›´æ–°ï¼Œå°±å¾—ä¸åˆ°æ­£ç¡®çš„æ ¹hashå€¼
- å¦‚æœæ™ºèƒ½åˆçº¦å‡ºé”™ä¹Ÿè¦å‘å¸ƒåˆ°åŒºå—é“¾ä¸Šï¼Œå› ä¸ºä¹Ÿè¦æœ‰Gas Fee
- æ™ºèƒ½åˆçº¦æ”¯ä¸æ”¯æŒå¤šæ ¸å¹¶è¡Œå¤„ç†ï¼Ÿä¸æ”¯æŒï¼Œå› ä¸ºçŠ¶æ€æœºå¿…é¡»æ˜¯å®Œå…¨ç¡®å®šï¼ŒåŒæ—¶ä¹Ÿä¸èƒ½äº§ç”ŸçœŸéšæœºæ•°

### Gas Fee

- æ™ºèƒ½åˆçº¦æ˜¯ä¸ªTuring-complete Programming Model å›¾çµå®Œå¤‡çš„ç¼–ç¨‹è¯­è¨€å•Šï¼Œè¿™ä¸ªç©æ„çœŸçš„æ˜¯

    - å‡ºç°æ­»å¾ªç¯æ€ä¹ˆåŠï¼Ÿå› ä¸ºæœ‰Gas Limitï¼Œæ‰€ä»¥å³ä½¿æ˜¯Halting Problem(åœæœºé—®é¢˜)ä¹Ÿæ²¡å…³ç³»

- æ‰§è¡Œåˆçº¦ä¸­çš„æŒ‡ä»¤è¦æ”¶å–æ±½æ²¹è´¹ï¼Œç”±å‘èµ·äº¤æ˜“çš„äººæ¥æ”¯ä»˜

    ```go
    type txdata struct {
    	AccountNonce uint64  `json : "nonce"   gencodec : "required"`
        Price 		 *bigInt `json: "gasPrice" gencodec : "required"`
        GasLimit     uint64  `json: "gas"      gencodec : "required"`
    	Recipient    *commonAddress `json:"to" rlp: "nil"` // nil means contract    creation æ”¶æ¬¾äººåœ°å€
        Amount       *bigInt `json: "value"    gencodec : "required"`//è½¬è´¦é‡‘é¢
    	Payload      []byte  `json: "input"    gencodec : "required"`//dataåŸŸ
    }
    ```

- EVMä¸­ä¸åŒæŒ‡ä»¤æ¶ˆè€—çš„æ±½æ²¹è´¹æ˜¯ä¸ä¸€æ ·çš„

- ç®€å•çš„æŒ‡ä»¤å¾ˆä¾¿å®œï¼Œå¤æ‚çš„æˆ–è€…éœ€è¦å­˜å‚¨çŠ¶æ€çš„æŒ‡ä»¤å°±å¾ˆè´µ

### é”™è¯¯å¤„ç†

- æ‰§è¡Œå…·æœ‰åŸå­æ€§ï¼Œå®Œå…¨æ‰§è¡Œæˆ–è€…å®Œå…¨ä¸æ‰§è¡Œ

- å¦‚æœGasFeeä¸å¤Ÿçš„è¯å°±ä¼šå›æ»šäº¤æ˜“ï¼Œä½†Gasä¹Ÿä¸ä¼šé€€å›ï¼Œé˜²æ­¢DDosæ”»å‡»ï¼›å‰©ä¸‹çš„ä¼šé€€å›

- æ™ºèƒ½åˆçº¦ä¸­ä¸å­˜åœ¨è‡ªå®šä¹‰çš„try-catchç»“æ„

- ä¸€æ—¦é‡åˆ°å¼‚å¸¸ï¼Œé™¤ç‰¹æ®Šæƒ…å†µå¤–ï¼Œæœ¬æ¬¡æ‰§è¡Œæ“ä½œå…¨éƒ¨å›æ»š

- å¯ä»¥æŠ›å‡ºé”™è¯¯çš„è¯­å¥:

    - assert(bool condition):å¦‚æœæ¡ä»¶ä¸æ»¡è¶³å°±æŠ›å‡ºâ€”ç”¨äºå†…éƒ¨é”™è¯¯ã€‚ 

    - require(bool condition):å¦‚æœæ¡ä»¶ä¸æ»¡è¶³å°±æŠ›æ‰â€”ç”¨äºè¾“å…¥æˆ–è€…å¤–éƒ¨ç»„ä»¶å¼•èµ·çš„é”™è¯¯ã€‚

    - ```solidity
        function bid() public payable {
        	//å¯¹äºèƒ½æ¥æ”¶ä»¥å¤ªå¸çš„å‡½æ•°ï¼Œå…³é”®å­—payableæ˜¯å¿…é¡»çš„ã€‚
        	// æ‹å–å°šæœªç»“æŸ
        	require( now <= auctionEnd) ;
        }
        ```
    
- revert():ç»ˆæ­¢è¿è¡Œå¹¶å›æ»šçŠ¶æ€å˜åŠ¨ã€‚ 

### åµŒå¥—è°ƒç”¨

- æ™ºèƒ½åˆçº¦çš„æ‰§è¡Œå…·æœ‰åŸå­æ€§:æ‰§è¡Œè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œä¼šå¯¼è‡´å›æ»š
- åµŒå¥—è°ƒç”¨æ˜¯æŒ‡ä¸€ä¸ªåˆçº¦è°ƒç”¨å¦ä¸€ä¸ªåˆçº¦ä¸­çš„å‡½æ•°
- åµŒå¥—è°ƒç”¨æ˜¯å¦ä¼šè§¦å‘è¿é”å¼çš„å›æ»š?
    - å¦‚æœè¢«è°ƒç”¨çš„åˆçº¦æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸ï¼Œä¼šä¸ä¼šå¯¼è‡´å‘èµ·è°ƒç”¨çš„è¿™ä¸ªåˆçº¦ä¹Ÿè·Ÿç€ä¸€èµ·å›æ»š?
    - æœ‰äº›è°ƒç”¨æ–¹æ³•ä¼šå¼•èµ·è¿é”å¼çš„å›æ»šï¼Œæœ‰äº›åˆ™ä¸ä¼š
- ä¸€ä¸ªåˆçº¦ç›´æ¥å‘ä¸€ä¸ªåˆçº¦å¸æˆ·é‡Œè½¬è´¦,æ²¡æœ‰æŒ‡æ˜è°ƒç”¨å“ªä¸ªå‡½æ•°,ä»ç„¶ä¼šå¼•èµ·åµŒå¥—è°ƒç”¨ï¼Œæ¯”å¦‚è°ƒç”¨fallbackå‡½æ•°

### Block Headerä¸Gasæœ‰å…³çš„éƒ¨åˆ†

- Gas Limit
    - BTCå¯ä»¥ç”¨1Må¤§å°æ¥çº¦æŸèµ„æºä½¿ç”¨ï¼Œè€ŒETHä½¿ç”¨Gas Limitæ¥çº¦æŸèµ„æºä½¿ç”¨ï¼Œè¿™ä¸ªLimitå¯ä»¥ç”±çŸ¿å·¥å¾®è°ƒï¼Œå¯ä»¥ä¸Šä¸‹è°ƒæ•´$\frac1{1024}$
- Gas Used

### Receiptæ•°æ®ç»“æ„

- ä¸‰æ£µæ ‘ç»´æŠ¤åœ¨å…¨èŠ‚ç‚¹æœ¬åœ°ï¼Œè®°å½•è´¦æˆ·çŠ¶æ€ï¼Œåªæœ‰åˆçº¦æ‰§è¡Œå®Œï¼Œå‘å¸ƒåœ¨åŒºå—ä¸Šä¹‹åï¼Œæœ¬åœ°ä¿®æ”¹æ‰å¯å˜æˆå¤–éƒ¨å¯è§çš„ï¼Œæ‰å¯ä»¥å˜æˆå…±è¯†
- å…ˆæŒ–çŸ¿ or  å…ˆæ‰§è¡Œåˆçº¦ ï¼Ÿ
    - å…ˆæ‰§è¡Œåˆçº¦ï¼Œè·å¾—ä¸‰æ£µæ ‘çš„æ ¹hashï¼Œå†å°è¯•nonce 
    - æ‰§è¡Œåˆçº¦ï¼Œä½†æ²¡æŒ–åˆ°åŒºå—
        - è¡¥å¿å‘¢ï¼Ÿæ²¡æœ‰ï¼Œä¸ä»…å¦‚æ­¤ï¼Œè¿˜å¾—æŠŠåˆ«äººå‘å¸ƒçš„åŒºå—ä¸Šçš„äº¤æ˜“æ‰§è¡Œä¸€éã€‚
- gas fee æ”¶å–ï¼Ÿ->   ä»æœ¬åœ°è´¦æˆ·ä½™é¢ä¸­å‡æ‰
- æ‰§è¡Œé”™è¯¯çš„åˆçº¦ä¹Ÿè¦å‘å¸ƒåˆ°åŒºå—ä¸Šï¼Œæ‰£gas fee 
- æ¯ä¸ªäº¤æ˜“æ‰§è¡Œå®Œå½¢æˆæ”¶æ®æ ‘ï¼Œstatus è¡¨ç¤ºæ‰§è¡Œæƒ…å†µ
- æ™ºèƒ½åˆçº¦æ˜¯å¦æ”¯æŒå¤šæ ¸å¹¶è¡Œå¤„ç†ï¼Ÿå¤šçº¿ç¨‹
    - ä¸æ”¯æŒï¼ŒEtthereumæ˜¯äº¤æ˜“é©±åŠ¨çš„çŠ¶æ€æœºï¼Œé¢å¯¹åŒä¸€ç»„è¾“å…¥ï¼Œäº§ç”Ÿçš„è¾“å‡ºå¿…é¡»/è½¬ç§»åˆ°çš„ä¸‹ä¸€ä¸ªçŠ¶æ€å¿…é¡»ç¡®å®šï¼Œ(å› ä¸ºæ‰€æœ‰å…¨èŠ‚ç‚¹å¿…é¡»æ‰§è¡ŒéªŒè¯)
    - å¤šçº¿ç¨‹ï¼Ÿå¤šä¸ªæ ¸å¯¹å†…å­˜è®¿é—®é¡ºåºä¸åŒï¼Œæ‰§è¡Œç»“æœæœ‰å¯èƒ½ä¸ç¡®å®š

```go
// Receipt represents the results of a transaction.
type Receipt struct {
	// consensus fields
    Poststate 		  []byte `json : "root"` 
	Status 			  uint64 `json : "status"`
	CumulativeGasUsed uint64 `json: " cumulativeGasUsed" gencodec : "required"`
	Bloom 			  Bloom  `json : "logsBloom"         gencodec : "required"`
	Logs			  []*Log `json: "logs"               gencodec : "required"`
	
	// Implementation fields (don't reorder ! )
	TxHash 			  common.Hash     `json : "transactionHash" gencodec : "required"`
	ContractAddress   common.Address `json : "contractAddress"`
	Gasused           uint64          `json : "gasused"         gencodec : "required"`
}
```

`Status`è¡¨ç¤ºæ‰§è¡ŒçŠ¶æ€

### æ™ºèƒ½åˆçº¦å¯ä»¥è·å¾—çš„åŒºå—ä¿¡æ¯

æ™ºèƒ½åˆçº¦ä¸èƒ½åƒé€šç”¨çš„ç¼–ç¨‹è¯­è¨€ä¸€æ ·é€šè¿‡ç³»ç»Ÿè°ƒç”¨è·å–ç¯å¢ƒä¿¡æ¯ï¼Œæ¯ä¸ªå…¨èŠ‚ç‚¹æ‰§è¡Œç¯å¢ƒä¸åŒï¼Œåªèƒ½é€šè¿‡å›ºå®šçš„ä¸€äº›å˜é‡å€¼è·å–åŒºå—é“¾çŠ¶æ€ä¿¡æ¯

- `block.blockhash(uint blockNumber) returns (bytes32)`:ç»™å®šåŒºå—çš„å“ˆå¸Œ-ä»…å¯¹æœ€è¿‘çš„256ä¸ªåŒºå—æœ‰æ•ˆè€Œä¸åŒ…æ‹¬å½“å‰åŒºå—
- `block.coinbase (address)`:æŒ–å‡ºå½“å‰åŒºå—çš„çŸ¿å·¥åœ°å€
- `block.difficulty (uint)`:å½“å‰åŒºå—éš¾åº¦
- `block.gaslimit (uint)`:å½“å‰åŒºå—gasé™é¢
- `block.number(uint)`:å½“å‰åŒºå—å·
- `block.timestamp (uint)`:è‡ªunix epoch èµ·å§‹å½“å‰åŒºå—ä»¥ç§’è®¡çš„æ—¶é—´æˆ³

### æ™ºèƒ½åˆçº¦å¯ä»¥è·å¾—çš„è°ƒç”¨ä¿¡æ¯

- `msg.data(bytes)`:å®Œæ•´çš„calldata
- `msg.gas(uint)`:å‰©ä½™gas
- `msg.sender(address)`:æ¶ˆæ¯å‘é€è€…ï¼ˆå½“å‰è°ƒç”¨)
- `msg.sig(bytes4)`: calldataçš„å‰4å­—èŠ‚ï¼ˆä¹Ÿå°±æ˜¯å‡½æ•°æ ‡è¯†ç¬¦)
- `msg.value(uint)`:éšæ¶ˆæ¯å‘é€çš„weiçš„æ•°é‡
- `now(uint)`:ç›®å‰åŒºå—æ—¶é—´æˆ³( block.timestamp )
- `tx.gasprice(uint)`:äº¤æ˜“çš„gasä»·æ ¼
- `tx.origin(address)`:äº¤æ˜“å‘èµ·è€…ï¼ˆå®Œå…¨çš„è°ƒç”¨é“¾)

æ³¨æ„ï¼šæ¶ˆæ¯å‘é€è€…å’Œäº¤æ˜“å‘èµ·è€…ä¸ä¸€å®šç›¸åŒï¼Œå‰è€…æ˜¯å½“å‰åˆçº¦è°ƒç”¨æ–¹ï¼ˆå±€éƒ¨ï¼‰ï¼Œè€Œåè€…æ˜¯æ•´ä¸ªè°ƒç”¨é“¾æœ€åˆçš„å‘èµ·è€…

### åœ°å€ç±»å‹

#### æˆå‘˜å˜é‡ï¼š

`<address>.balance(uint256)`:ä»¥Weiä¸ºå•ä½çš„åœ°å€ç±»å‹çš„ä½™é¢ã€‚

#### æˆå‘˜å‡½æ•°ï¼š

æ³¨æ„ä¸‹é¢çš„addresséƒ½æ˜¯**è½¬å…¥åœ°å€/è¢«è°ƒç”¨åœ°å€**

`<address>.transfer(uint256 amount)`:å½“å‰åˆçº¦è´¦æˆ·å‘**åœ°å€ç±»å‹ï¼ˆè½¬å…¥åœ°å€ï¼‰**å‘é€æ•°é‡ä¸ºamountçš„Weiï¼Œå¤±è´¥æ—¶æŠ›å‡ºå¼‚å¸¸ï¼Œå‘é€2300gasçš„çŸ¿å·¥è´¹ï¼Œä¸å¯è°ƒèŠ‚ã€‚**ä¼šäº§ç”Ÿè¿é”å›æ»š**ã€‚gas feeæ¯”è¾ƒå°‘ï¼ŒåŸºæœ¬åªèƒ½å†™ä¸ªlog

`<address>.send(uint256 amount) returns (bool)`:å‘åœ°å€ç±»å‹å‘é€æ•°é‡ä¸ºamountçš„ weiï¼Œå¤±è´¥æ—¶è¿”å›falseï¼Œå‘é€2300gas çš„çŸ¿å·¥è´¹ç”¨ï¼Œä¸å¯è°ƒèŠ‚ã€‚**ä¸ä¼šäº§ç”Ÿè¿é”å›æ»š**ï¼Œgas feeæ¯”è¾ƒå°‘ï¼ŒåŸºæœ¬åªèƒ½å†™ä¸ªlog

`<address>.call(...) returns (boo1)`:å‘å‡ºåº•å±‚`CALL`ï¼Œå¤±è´¥æ—¶è¿”å›falseï¼Œå‘é€æ‰€æœ‰å¯ç”¨gasï¼Œä¸å¯è°ƒèŠ‚ã€‚

- `<address>.call.value(uint256 amount) returns (bool)()`ï¼Œ**ä¸ä¼šäº§ç”Ÿè¿é”å›æ»š**ï¼Œå‘é€æ‰€æœ‰å¯ç”¨gasï¼Œå¯ç”¨åšæ›´å¤šçš„äº‹æƒ…

`<address>.callcode(...) returns (boo1) `:å‘å‡ºåº•å±‚`CALLCODE`ï¼Œå¤±è´¥æ—¶è¿”å›falseï¼Œå‘é€æ‰€æœ‰å¯ç”¨gasï¼Œä¸å¯è°ƒèŠ‚ã€‚

`<address>.delegatecall(...) returns (boo1)`:å‘å‡ºåº•å±‚`DELEGATECALL`ï¼Œå¤±è´¥æ—¶è¿”å›falseï¼Œå‘é€æ‰€æœ‰å¯ç”¨gasï¼Œä¸å¯è°ƒèŠ‚ã€‚

æ‰€æœ‰æ™ºèƒ½åˆçº¦å‡å¯æ˜¾å¼åœ°è½¬æ¢æˆåœ°å€ç±»å‹

## ETH-TheDAO

DAOï¼šDecentralized Autonomous Organization 

TheDAOï¼Œ2016å¹´5æœˆå‡ºç°çš„ä¸€ä¸ªæŠ•èµ„è‡ªæ²»ç»„ç»‡ï¼Œå°†ETHæ¢å–TheDAOçš„ä»£å¸ï¼Œä½œä¸ºæŠ•èµ„çš„æŠ•ç¥¨æƒï¼Œä¹Ÿæ˜¯æœ€ååˆ’åˆ†å—ç›Šçš„æ¯”ä¾‹

æ”¶å–æ”¶ç›Šæ˜¯ä½¿ç”¨splitDAOæ–¹æ³•ï¼Œæ‹†åˆ†The DAOå¯ä»¥æˆç«‹childDAOï¼Œæˆç«‹ä¹‹åæœ‰28å¤©é”å®šæœŸ  

Hackeråˆ©ç”¨é‡å½•æ”»å‡»ã€‚ETHå›¢é˜Ÿå†³å®šå›æ»šï¼ŒåŸåˆ™æ˜¯åªå›æ»šä¸è¯¥äº¤æ˜“æœ‰å…³çš„å†…å®¹

ç¬¬ä¸€æ­¥ï¼šä¿®æ”¹åè®®ï¼Œå’ŒTheDAOæœ‰å…³çš„è´¦æˆ·ä¸èƒ½è¿›è¡Œäº¤æ˜“â€”â€”è½¯åˆ†å‰ï¼Œä½†æ˜¯å‡ºç°äº†BUGï¼Œä¸è¿™äº›è´¦æˆ·è¿›è¡Œäº¤æ˜“åº”è¯¥æ˜¯éæ³•äº¤æ˜“ï¼Œä½†æ˜¯gas feeè¿˜æ˜¯è¦æ”¶çš„ï¼Œä»¥æ”¾DDosæ”»å‡»ï¼Œä½†æ˜¯ä¿®æ”¹çš„æ—¶å€™å‡ºç°BUGï¼Œè¿™ç±»äº¤æ˜“æ²¡æœ‰æ”¶gas feeï¼Œæœ€åçŸ¿å·¥å›æ»šç‰ˆæœ¬ï¼Œè¿™ä¸ªæ–¹æ¡ˆå°±å¤±è´¥äº†

ç¬¬äºŒæ­¥ï¼šä¸TheDAOç›¸å…³çš„è´¦æˆ·å¼ºè¡Œè½¬åˆ°æ–°è´¦æˆ·ä¸Šå»ï¼Œè€Œä¸éœ€è¦ç­¾åç­‰â€”â€”ç¡¬åˆ†å‰

ETHåˆ†è£‚æˆETHå’ŒETC (Ethereum Classic)ï¼Œç»™è¿™ä¸¤æ¡é“¾åŠ ä¸ŠchainID

## ETH-åæ€

- æ™ºèƒ½åˆçº¦æ˜¯å¦çœŸçš„æ™ºèƒ½ï¼Ÿ

    å®é™…ä¸Šæ˜¯è‡ªåŠ¨åˆçº¦ï¼Œç±»ä¼¼äºATMæœº

- ä¸å¯ç¯¡æ”¹æ€§æ˜¯åŒåˆƒå‰‘ 

    - è½¯ä»¶å‡çº§,å†»ç»“è´¦æˆ·ï¼Œæ— æ³•åœæ­¢å¯¹æ™ºèƒ½åˆçº¦çš„è°ƒç”¨

- æ²¡æœ‰ä»€ä¹ˆæ˜¯ä¸å¯ç¯¡æ”¹çš„

    - ä»£ç æ˜¯æ­»çš„ï¼Œäººæ˜¯æ´»çš„
    - é‡å¤§äº‹ä»¶æƒ³æ”¹è¿˜æ˜¯èƒ½æ”¹çš„

- solidityå­˜åœ¨é—®é¢˜ï¼Œå¯ä»¥å°è¯•é‡‡ç”¨å‡½æ•°å¼è¯­è¨€ã€Formal Verificationã€**æ¨¡æ¿**ã€ä¸“é—¨çš„æ™ºèƒ½åˆçº¦æœºæ„ã€‚æœ‰äº›äººè®¤ä¸ºè¯­è¨€è¡¨è¾¾èƒ½åŠ›è¦é€‚ä¸­ï¼Œä½†å¾ˆéš¾é¢„æ–™åˆ°ä¹‹åçš„æ”»å‡»å’Œæ¼æ´ç­‰ã€‚

    - æ™ºèƒ½åˆçº¦çš„å†å²çš„è¿˜æ˜¯çŸ­ï¼Œå¸Œæœ›é€æ¸èµ°å‘æˆç†Ÿ

- åˆçº¦ä»£ç å¼€æºæé«˜å…±æ€§åŠ›å’Œå®‰å…¨ï¼Œä½†æ˜¯è¿˜æ˜¯å­˜åœ¨æ¼æ´ï¼Œç§°ä¸ºmany eyeball fallacyï¼Œè¦å°å¿ƒä»”ç»†

- ç¡¬åˆ†å‰çš„è¿‡ç¨‹æ˜¯å¦åªæ˜¯æ ¸å¿ƒå›¢é˜Ÿçš„å†³ç­–ï¼Ÿå¹¶ä¸æ˜¯ï¼Œè€Œæ˜¯å¹¿å¤§çŸ¿å·¥ç”¨è„šæŠ•ç¥¨çš„ç»“æœï¼Œåˆ†å‰æ˜¯æ°‘ä¸»çš„ä½“ç°

- å»ä¸­å¿ƒåŒ–ä¸ç­‰äºåˆ†å¸ƒå¼ç³»ç»Ÿï¼Œå‰è€…ä¸€å®šæ˜¯åˆ†å¸ƒçš„ï¼Œä½†åè€…ä¸ä¸€å®šæ˜¯å»ä¸­å¿ƒåŒ–çš„ã€‚åè€…æ˜¯ç”¨å¤šä¸ªæœºå™¨æ¥æé«˜è¿è¡Œæ•ˆç‡ï¼Œå‰è€…æ˜¯ä¸ºäº†å®¹é”™ï¼ˆçŠ¶æ€æœºæ¨¡å¼ï¼Œæœºå™¨æ•°ç›®è¶Šå¤šè¶Šæ…¢ï¼‰

## ETH-ç¾é“¾ 

Beauty Chainæ˜¯åœ¨éƒ¨ç½²åœ¨ä»¥å¤ªåŠä¸Šçš„æ™ºèƒ½åˆçº¦ï¼Œæœ‰è‡ªå·±çš„ä»£å¸BEC   

ICOï¼šInital Coin Offering

IPOï¼šInitial Public Offering

ERC 20ï¼ˆEthereum Request for Commentsï¼‰æ˜¯ä»¥å¤ªåŠå‘å¸ƒä»£å¸çš„æ ‡å‡†

`uint256 amount = uint  256(cnt) * _value`å‡ºç°é—®é¢˜ï¼ˆ`cnt`è¡¨ç¤ºæ¥å—è½¬è´¦çš„è´¦æˆ·ä¸ªæ•°ï¼‰ï¼Œå¦‚æœ`_value`å¾ˆå¤§ï¼Œå°±ä¼šå¯¼è‡´æº¢å‡ºä½¿å¾—`amount`å˜å¾—å¾ˆå°ï¼Œæ•…å½“å‰è´¦æˆ·åªæ‰£ä¸€ç‚¹ç‚¹é’±ï¼Œè€Œå…¶ä»–è´¦æˆ·ä¼šå—åˆ°ä¸€å¤§ç¬”é’±

solidityæœ‰ä¸“é—¨çš„æ•°å­¦åº“`SafeMath`åº“ï¼Œä¼šè‡ªåŠ¨æ£€æµ‹æ˜¯å¦æº¢å‡º 

## è¯¾ç¨‹æ€»ç»“

ä¸­å¿ƒåŒ–å’Œå»ä¸­å¿ƒåŒ–ä¸æ˜¯æ³¾æ¸­åˆ†æ˜çš„ï¼Œä¸€ä¸ªç³»ç»Ÿå¯ä»¥æœ‰ä¸­å¿ƒåŒ–æˆåˆ†ä¹Ÿå¯ä»¥æœ‰å»ä¸­å¿ƒåŒ–æˆåˆ†ã€‚

åŠ å¯†è´§å¸åº”è¯¥ç”¨åœ¨ä¼ ç»Ÿè´§å¸ä¸èƒ½å¾ˆå¥½è§£å†³çš„åœºæ™¯ï¼Œä¾‹å¦‚è·¨å¢ƒè½¬è´¦

åŠ å¯†è´§å¸å¹¶éä¸ä¼ ç»Ÿæ”¯ä»˜ç«äº‰ï¼Œè€ƒè™‘ç‰¹å®šçš„å†å²æ¡ä»¶ã€å„æ–¹é¢çš„å› ç´ 

ç¨‹åºåŒ–æ˜¯ä¸€ä¸ªå¤§è¶‹åŠ¿ï¼Œè½¯ä»¶å°†ä¼šæ”¹å˜ä¸–ç•Œ

å»ä¸­å¿ƒåŒ–ï¼Œæ™ºèƒ½åˆçº¦ä¸èƒ½è§£å†³æ‰€æœ‰é—®é¢˜ï¼Œæ°‘ä¸»ä¸ä¸€å®šæ˜¯å¥½äº‹æƒ…ï¼Œæ°‘ä¸»ä¸ä¸€å®šæ˜¯æ›´å®Œç¾çš„åˆ¶åº¦ï¼Œå…·ä½“é—®é¢˜å…·ä½“åˆ†æ
